# Example with fish data from NORS

In this example we are interested in exploring data from a specific data resource -- Sjöprovfiskedatabasen NORS (Institutionen för akvatiska resurser, SLU). This data base has 2.8 M observations starting in the 1950's.

As you may already know, SBDI is a collection of many biodiversity databases. We start by searching for the data resource we are interested in using the function `pick_filter()`. This is an interactive query guiding you through the many resources available to filtering your query (data resources, spatial layers, and curated species lists).

```{r, message=FALSE, eval=FALSE}
fq_str <- pick_filter("resource") 
# follow the instructions 
```

Follow the instruction. Your choices here would have been "in3" --> "dr20". Your variable `fq_str` will now contain a string "data_resource_uid:dr20".

```{r}
# we cant do it interactive here so we force it
fq_str <- "data_resource_uid:dr20"
```

But we are not interested in the complete database, but on the last 10 years of data. for this we concatenate (add to a vector) another filter string. These will be treated as AND factors.

```{r}
y1 <- 2012
y2 <- 2021
fq_str <- c(fq_str, paste0("year:[", y1, " TO ", y2,"]"))
# Note the square brackets are hard limits
```

For references on how to use the filters see documentation at [docs](link).

Using the function `occurrences()` we can the query for the observations fulfilling our filter. If you haven't specified that in the `sbdi_config()` before (see [Case 1: Example with fish data from NORS] Installation), you need to pass your email and the download reason.

```{r getOcc, cache=FALSE}
library(SBDI4R)
xf <- occurrences(fq = fq_str,
                 email = "alejandro@greensway.se", 
                 download_reason_id=10)

# Simply summarise all records by data source 
table(xf$data$dataResourceName)
```

## Plotting data on a map

You can quickly plot all the observations as a PDF file with the function `ocurrence_plot()`, one page per species:

```{r pdf_plot, eval=FALSE}
occurrences_plot(x, "obsPlot.pdf", 
                 grouped=FALSE, 
                 taxon_level="species", 
                 pch='+')
```

Note that the plot is saved to a pdf file in the current working directory. You can find that with `getwd()`.

#### Leaflet

There are many other ways of producing spatial plots in R. The leaflet package provides a simple method of producing browser-based maps with panning, zooming, and background layers:

```{r leaflet, message=FALSE, warning=FALSE}
library(leaflet)
# drop any records with missing lat/lon values
xfl <- xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),] 
marker_colour <- rep("#d95f02", nrow(xfl))
# blank map, with imagery background
leaflet(width = "100%") %>% 
  addProviderTiles("Esri.WorldImagery") %>%
  # add markers
  addCircleMarkers(xfl$longitude, xfl$latitude,  
                   radius = 1, 
                   fillOpacity =.5, 
                   opacity = 1,
                   col=marker_colour,
                  clusterOptions = markerClusterOptions())
```

## Temporal analysis

A quick summary over the years reveal a drop in number of records over time, and stops .

```{r}
table(xf$data$year)
```

```{r}
hist(xf$data$year, 
     breaks = seq(y1, y2), 
     xlab = "Year", 
     main = "")
```

## Species summary

In the same way we can summaries the number of observations for each species, by common or scientific name.

```{r nObsTab, paged.print=TRUE}
sppTab <- table(xf$data$commonName)
sppDF <- as.data.frame(sppTab)
colnames(sppDF)[1] <- "species"
sppDF
```

```{r nObsTab2, paged.print=TRUE}
sppTab <- table(xf$data$scientificName)
sppDF <- as.data.frame(sppTab)
colnames(sppDF)[1] <- "species"
sppDF
```

Perhaps, you need to send this table as a .CSV file to a colleague.

```{r, eval=FALSE}
write.csv(sppDF, "NORS species summary.csv")
# NOTE: again this will be saved on your working directory
```

## Spatial biodiversity analysis

Let's now ask: how does the species richness vary across Sweden? In this case we want to summarise occurrences species-wise over a defined grid instead of plotting every observation point. First we need to overlay the observations with a grid. In this case, the standard Swedish grids at 50, 25, 10 and 5 km are provided as data in the SBDI4R package (with Coordinate Reference System = WGS84, EPSG:4326).

```{r overlay}
library(sp) # the function coordinates() and proj4string() are in sp
library(rgeos) # the function over() is in package rgeos
# load some shapes over Sweden's political borders
data("swe_wgs84", package="SBDI4R", envir=environment())
# A standard 50km grid
data("Sweden_Grid_50km_Wgs84", package="SBDI4R", envir=environment())

grid <- Sweden_Grid_50km_Wgs84
# grid <- spTransform(grid, CRS("+init=epsg:4326")) # as mentioned above, the grid already has has the same CRS, but changes are undergoing in the sp package and this step is needed

# make the observations spatial
# NOTE: make sure there are no NAs on either column defining the coordinates
# xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),]

obs <- as.data.frame(xf$data)
coordinates(obs) <- obs[,c("longitude","latitude")]
wkt <- sf::st_crs(4326)[[2]]
proj4string(obs) <- sp::CRS(wkt) #CRS("+init=epsg:4326")

nObs <- nrow(obs)

# overlay the data with the grid
ObsInGridList <- over(grid, obs, returnList=TRUE)
wNonEmpty <- unname( which( unlist(lapply(ObsInGridList, nrow)) != 0) )
if(length(wNonEmpty)==0) message("Observations don't overlap any grid cell.")
```

The result `ObsInGridList` is a `list` object with a subset of the data on each grid. Now summarise occurrences within grid cells:

```{r overlay_summary}
# check n the total number of observations
sum(unlist(lapply(ObsInGridList, nrow)))

# apply a summary over the grid cells 
nCells <- length(ObsInGridList)

res <- data.frame("nObs"=as.numeric(rep(NA,nCells)),
                  "nYears"=as.numeric(rep(NA,nCells)),
                  "nSpp"=as.numeric(rep(NA,nCells)),
                  row.names = row.names(grid),
                  stringsAsFactors = FALSE)

cols2use <- c("scientificName", "year")

dataRes <- lapply(ObsInGridList[wNonEmpty], function(x){
  x <- x[,cols2use]
  colnames(x) <- c("scientificName", "year")
  return(c("nObs" = length(x[,"scientificName"]),
           "nYears" = length(unique(x[,"year"])),
           "nSpp" = length(unique(x[,"scientificName"]))
           ))
  })

dataRes <- as.data.frame(dplyr::bind_rows(dataRes, .id = "gridID"))

res[wNonEmpty,] <- dataRes[,-1]

resSp <- sp::SpatialPolygonsDataFrame(grid, res)
```

And finally plot the grid summary as a map:

```{r grid, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
palBW <- leaflet::colorNumeric(c("white", "navyblue"),
                               c(0, max(resSp@data$nSpp, na.rm = TRUE)),
                               na.color = "transparent")
oldpar <- par()
par(mar = c(1,1,0,0))
plot(resSp, col=palBW(resSp@data$nSpp), border = NA)
plot(swe_wgs84$Border, border=1, lwd=1, add=T)
legend("bottomleft", 
       legend = round(seq(0, max(resSp@data$nSpp, na.rm = TRUE), length.out = 5)),
       col = palBW(seq(0, max(resSp@data$nSpp, na.rm = TRUE), length.out = 5)),
       title = "Number of \nspecies", pch = 15, bty="n")
suppressWarnings(par(oldpar))
```


[TO BE CONTINUED]
[perhaps add, use from Example 5:] species richness vs latitude
Let’s now ask – can we see any trends for species over the 20 yrs?:
First we check whether spatial sampling effort was comparable across those years – can we quickly check number of sampling sites over years?
And we ask: can we see a trend (change = frequency of occurrence = number caught) for species X, or species Y?
[above may already be enough, nots sure we can/should fit more, but if we have time:]
And we ask: can we see a relationship between species occurrence and the environment? For example species X and temperature?

Link to analyses of interest – e.g. species distribution models, or trend analyses, or species divesity – link to biodiversity workflow

