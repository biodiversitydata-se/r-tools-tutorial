---
title: "<img src='sbdi-logo-orginal-large.png' class='cover'/> <br><br> Tutorial for using R tools for analysis of primary biodiversity data provided by SBDI"
author: "Debora Arlt and Alejandro Ruete <br>for the Swedish Biodiversity Data Infrastructure" 
date: "`r Sys.Date()`"
description: "A set of examples for using SBDI4R" 
output: bookdown::gitbook
site: bookdown::bookdown_site
documentclass: book
bibliography:
- references.bib
biblio-style: apalike
link-citations: yes
colorlinks: yes
graphics: yes
lot: yes
lof: yes
fontsize: 11pt
mainfont: Palatino
monofont: "Source Code Pro"
monofontoptions: "Scale=0.8"
github-repo: https://github.com/biodiversitydata-se/r-tools-tutorial
cover-image: sbdi-logo-orginal-large.png
---
```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```

# Introduction {.unnumbered}

Biodiversity resources are increasingly international. The SBDI has made an effort to canalize biodiversity data and resources to help the research community access and analyze Swedish primary biodiversity data. Each research question draws its own challenges which are unique in themselves. Our aim here is to provide a few examples that prompt questions that may be asked at different stages of the process. The validity and appropriateness of a particular method depends on the individual researcher(s). For a comprehensive workflow on how to treat and analyze PBD please refer to our tutorial on [biodiversity analysis tool](https://github.com/biodiversitydata-se/biodiversity-analysis-tools) where we go through the complete workflow Data --> Cleaning --> Fitness evaluation --> Analysis 

`r htmltools::includeHTML("images/Workflow Overview Horizontal.html")`


## R and Mirroreum{.unnumbered}
The present tutorial is focused on the statistical programming language R, as this is a statistical and data-science an environment that is widely used within the scientific community and where the complete analysis workflow can be documented in a fully reproducible way. 

[TODO] Add a section on Mirroreum, use text from the sbdi webpage 
https://docs.biodiversitydata.se/analyse-data/mirroreum/, and Markus’ github repo 
https://github.com/mskyttner/mirroreum, and also include link to 
https://docs.biodiversitydata.se/analyse-data/mirroreum/  

## SBDI4R - R package to search an access data{.unnumbered}
The SBDI4R package enables the R community to directly access data and resources
hosted by SBDI. The goal is to enable observations of species to be
queried and output in a range of standard formats. It includes some filter functions 
that allow you to filter prior to download. It also includes some simple summary 
functions, and some function for some simple data exploration. The examples 
included in this tutorial also show you how you can continue exploring and analyzing
using other R package.

Please refer to the [package documentation](https://biodiversitydata-se.github.io/SBDI4R)
for details on how to install it. Once installed the SBDI4R package must be loaded
for each new R session:

```{r, message=FALSE, eval=TRUE}
library(SBDI4R)
```
## Customizing SBDI4R{.unnumbered}

Various aspects of the SBDI4R package can be customized, and even stored in
`.Rprofile` to be load automatically with the package.

### Caching{.unnumbered}

SBDI4R can cache most results to local files. This means that if the
same code is run multiple times, the second and subsequent iterations
will be faster. This will also reduce load on the web servers. By
default, this caching is session-based, meaning that the local files are
stored in a temporary directory that is automatically deleted when the R
session is ended. This behaviour can be altered so that caching is
permanent, by setting the caching directory to a non-temporary location.
For example, under Windows, use something like:

```{r, eval=FALSE}
sbdi_config(cache_directory = file.path("c:","mydata","sbdi_cache")) ## Windows
```

or for Linux:

```{r, eval=FALSE}
sbdi_config(cache_directory = "~/mydata/sbdi_cache") ## Linux
```

Note that this directory must exist (you need to create it yourself).

All results will be stored in that cache directory and will be used from
one session to the next. They won't be re-downloaded from the server
unless the user specifically deletes those files or changes the caching
setting to "refresh".

If you change the cache_directory to a permanent location, you may wish
to add something like this to your .Rprofile file, so that it happens
automatically each time the SBDI4R package is loaded:

```{r, eval=FALSE}
setHook(packageEvent("SBDI4R", "onLoad"), 
        function(...) sbdi_config(cache_directory=file.path("~","mydata","sbdi_cache")))
```

Caching can also be turned off entirely by:

```{r}
sbdi_config(caching="off")
```

or set to "refresh", meaning that the cached results will re-downloaded
from the SBDI servers and the cache updated. (This will happen for as
long as caching is set to "refresh" — so you may wish to switch back to
normal "on" caching behaviour once you have updated your cache with the
data you are working on).

### E-mail address{.unnumbered}

Each request to SBDI servers is also accompanied by an "e-mail address"
string that identifies the user making the request. This is a standard
behaviour used by web browsers as well. There is no default for this
field. You can provide your e-mail address as a parameter directly to
each call of the function occurrences(), or you can set it once per
session specifying it in the package configuration:

```{r, eval=FALSE}
sbdi_config(email="your.valid@emailaddress.com")
```

### Setting the download reason{.unnumbered}

SBDI requires that you provide a reason when downloading occurrence data
(via the SBDI4R `occurrences()` function). You can provide this as a
parameter directly to each call of `occurrences()`, or you can set it
once per session using:

```{r, eval=FALSE}
sbdi_config(download_reason_id = "your_reason_id")
```
(See `sbdi_reasons()` for valid download reasons, e.g.
  * 3 for "education",
  * 7 for "ecological research", 
  * 8 for "systematic research/taxonomy", 
  * 10 for "testing")

*NO* other personal identification information is sent. You can see all
configuration settings, including the the user-agent string that is
being used, with the command:

```{r, eval=FALSE}
sbdi_config()
```
### Other options{.unnumbered}

If you make a request that returns an empty result set (e.g. an
un-matched name), by default you will simply get an empty data structure
returned to you without any special notification. If you would like to
be warned about empty result sets, you can use:

```{r}
sbdi_config(warn_on_empty=TRUE)
```


## Other packages needed {.unnumbered}

Some additional packages are needed for these examples. Install them if necessary 
with the following script.

```{r, message=FALSE}
to_install <- c("dplyr", "ggplot2", "jpeg", "leaflet","maps", "mapdata",
                "maptools", "sp", "rgeos", "tidyr", "vegan")
to_install <- to_install[!sapply(to_install, requireNamespace, quietly=TRUE)]
if(length(to_install)>0)
    install.packages(to_install, repos="http://cran.us.r-project.org")
```

## Your collaboration is appreciated {.unnumbered}
[TODO] Perhaps add short section about how to contribute to developments like Mirroreum, sbdi4r, the worksflow? 1) post issues on github, 2) contact sbdi support, 3) add suggestions (pull requests..) through github

## Contact
Please get in contact with us via the [support center](https://docs.biodiversitydata.se/support/) if you have questions regarding the use of the SBDI4R package.

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```
# Example with fish data from NORS

In this example we are interested in exploring data from a specific data resource -- Sjöprovfiskedatabasen NORS (Institutionen för akvatiska resurser, SLU). This data base has 2.8 M observations starting in the 1950's.

As you may already know, SBDI is a collection of many biodiversity databases. We start by searching for the data resource we are interested in using the function `pick_filter()`. This is an interactive query guiding you through the many resources available to filtering your query (data resources, spatial layers, and curated species lists).

```{r, message=FALSE, eval=FALSE}
fq_str <- pick_filter("resource") 
# follow the instructions 
```

Follow the instruction. Your choices here would have been "in3" --> "dr20". Your variable `fq_str` will now contain a string "data_resource_uid:dr20".

```{r}
# we cant do it interactive here so we force it
fq_str <- "data_resource_uid:dr20"
```

But we are not interested in the complete database, but on the last 10 years of data. for this we concatenate (add to a vector) another filter string. These will be treated as AND factors.

```{r}
y1 <- 2012
y2 <- 2021
fq_str <- c(fq_str, paste0("year:[", y1, " TO ", y2,"]"))
# Note the square brackets are hard limits
```

For references on how to use the filters see documentation at [docs](link).

Using the function `occurrences()` we can the query for the observations fulfilling our filter. If you haven't specified that in the `sbdi_config()` before (see [Case 1: Example with fish data from NORS] Installation), you need to pass your email and the download reason.

```{r getOcc, cache=FALSE}
library(SBDI4R)
xf <- occurrences(fq = fq_str,
                 email = "test@test.org", 
                 download_reason_id=10)

# Simply summarise all records by data source 
table(xf$data$dataResourceName)
```

## Plotting data on a map

You can quickly plot all the observations as a PDF file with the function `ocurrence_plot()`, one page per species:

```{r pdf_plot, eval=FALSE}
occurrences_plot(x, "obsPlot.pdf", 
                 grouped=FALSE, 
                 taxon_level="species", 
                 pch='+')
```

Note that the plot is saved to a pdf file in the current working directory. You can find that with `getwd()`.

#### Leaflet

There are many other ways of producing spatial plots in R. The leaflet package provides a simple method of producing browser-based maps with panning, zooming, and background layers:

```{r leaflet, message=FALSE, warning=FALSE}
library(leaflet)
# drop any records with missing lat/lon values
xfl <- xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),] 
marker_colour <- rep("#d95f02", nrow(xfl))
# blank map, with imagery background
leaflet(width = "100%") %>% 
  addProviderTiles("Esri.WorldImagery") %>%
  # add markers
  addCircleMarkers(xfl$longitude, xfl$latitude,  
                   radius = 1, 
                   fillOpacity =.5, 
                   opacity = 1,
                   col=marker_colour,
                  clusterOptions = markerClusterOptions())
```

## Temporal analysis

A quick summary over the years reveal a drop in number of records over time, and stops .

```{r}
table(xf$data$year)
```

```{r}
hist(xf$data$year, 
     breaks = seq(y1, y2), 
     xlab = "Year", 
     main = "")
```

## Species summary

In the same way we can summaries the number of observations for each species, by common or scientific name.

```{r nObsTab, paged.print=TRUE}
sppTab <- table(xf$data$commonName)
sppDF <- as.data.frame(sppTab)
colnames(sppDF)[1] <- "species"
sppDF
```

```{r nObsTab2, paged.print=TRUE}
sppTab <- table(xf$data$scientificName)
sppDF <- as.data.frame(sppTab)
colnames(sppDF)[1] <- "species"
sppDF
```

Perhaps, you need to send this table as a .CSV file to a colleague.

```{r, eval=FALSE}
write.csv(sppDF, "NORS species summary.csv")
# NOTE: again this will be saved on your working directory
```

## Spatial biodiversity analysis

Let's now ask: how does the species richness vary across Sweden? In this case we want to summarise occurrences species-wise over a defined grid instead of plotting every observation point. First we need to overlay the observations with a grid. In this case, the standard Swedish grids at 50, 25, 10 and 5 km are provided as data in the SBDI4R package (with Coordinate Reference System = WGS84, EPSG:4326).

```{r overlay}
library(sp) # the function coordinates() and proj4string() are in sp
library(rgeos) # the function over() is in package rgeos
# load some shapes over Sweden's political borders
data("swe_wgs84", package="SBDI4R", envir=environment())
# A standard 50km grid
data("Sweden_Grid_50km_Wgs84", package="SBDI4R", envir=environment())

grid <- Sweden_Grid_50km_Wgs84
# grid <- spTransform(grid, CRS("+init=epsg:4326")) # as mentioned above, the grid already has has the same CRS, but changes are undergoing in the sp package and this step is needed

# make the observations spatial
# NOTE: make sure there are no NAs on either column defining the coordinates
# xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),]

obs <- as.data.frame(xf$data)
coordinates(obs) <- obs[,c("longitude","latitude")]
wkt <- sf::st_crs(4326)[[2]]
proj4string(obs) <- sp::CRS(wkt) #CRS("+init=epsg:4326")

nObs <- nrow(obs)

# overlay the data with the grid
ObsInGridList <- over(grid, obs, returnList=TRUE)
wNonEmpty <- unname( which( unlist(lapply(ObsInGridList, nrow)) != 0) )
if(length(wNonEmpty)==0) message("Observations don't overlap any grid cell.")
```

The result `ObsInGridList` is a `list` object with a subset of the data on each grid. Now summarise occurrences within grid cells:

```{r overlay_summary}
# check n the total number of observations
sum(unlist(lapply(ObsInGridList, nrow)))

# apply a summary over the grid cells 
nCells <- length(ObsInGridList)

res <- data.frame("nObs"=as.numeric(rep(NA,nCells)),
                  "nYears"=as.numeric(rep(NA,nCells)),
                  "nSpp"=as.numeric(rep(NA,nCells)),
                  row.names = row.names(grid),
                  stringsAsFactors = FALSE)

cols2use <- c("scientificName", "year")

dataRes <- lapply(ObsInGridList[wNonEmpty], function(x){
  x <- x[,cols2use]
  colnames(x) <- c("scientificName", "year")
  return(c("nObs" = length(x[,"scientificName"]),
           "nYears" = length(unique(x[,"year"])),
           "nSpp" = length(unique(x[,"scientificName"]))
           ))
  })

dataRes <- as.data.frame(dplyr::bind_rows(dataRes, .id = "gridID"))

res[wNonEmpty,] <- dataRes[,-1]

resSp <- sp::SpatialPolygonsDataFrame(grid, res)
```

And finally plot the grid summary as a map:

```{r grid, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
palBW <- leaflet::colorNumeric(c("white", "navyblue"),
                               c(0, max(resSp@data$nSpp, na.rm = TRUE)),
                               na.color = "transparent")
oldpar <- par()
par(mar = c(1,1,0,0))
plot(resSp, col=palBW(resSp@data$nSpp), border = NA)
plot(swe_wgs84$Border, border=1, lwd=1, add=T)
legend("bottomleft", 
       legend = round(seq(0, max(resSp@data$nSpp, na.rm = TRUE), length.out = 5)),
       col = palBW(seq(0, max(resSp@data$nSpp, na.rm = TRUE), length.out = 5)),
       title = "Number of \nspecies", pch = 15, bty="n")
suppressWarnings(par(oldpar))
```

<!--chapter:end:01-fish-data.Rmd-->

```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```
Case 2:
Look at opportunistically collected citizen science data – using the big Swedish cit science species observation data portal Artportalen.

We want to look at dragonflies – but before we can use the observation records we need to know how the observation effort has varied over time and in space. For this we define field visits i.e. occasions at which an observer has sampled observations – if we have information on observer id, location id and date we can aggregate data into “field visits”. We do this using BIRDS, and 25km grid:
Select data – get records for Southern Sweden (Götaland) and years 2000-2010.
How has observation effort (frequency of visits) varied over time and space? – 1) show maps as in Example 7 (all years, year 2000, 2002, 2004, 2006, 2008, 2010), 2 make also a time line plot with no. visits against years, no. of gridcells with visits against years.

We can now look at some particular species and ask whether this has changed in occurrence over time:
Plot no. records of species x and no. visits all species over years (we simply explore by comparing records for a species with no visits, can assume that species has increased of stronger positive trend than for no. visits)
Plot no. gridcells with visits for species x and no. gridcells with visits for all species over years (we simply explore by comparing records for a species with no visits, can assume that species has increased of stronger positive trend than for no. visits)
(species x: Tvåfläckad trollslända Epitheca bimaculata)


<!--chapter:end:02-dragonflies-data.Rmd-->

