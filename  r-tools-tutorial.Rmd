---
title: "Tutorial for using SBDI4R for analysis of biodiversity primary data"
author: "Debora Arlt, Alejandro Ruete and Charles Campbell for the Swedish Biodiversity Data Infrastructure" 
date: "`r Sys.Date()`"
description: "A set of examples for using SBDI4R" 
output: bookdown::gitbook
site: bookdown::bookdown_site
documentclass: book
bibliography:
- references.bib
biblio-style: apalike
link-citations: yes
colorlinks: yes
graphics: yes
lot: yes
lof: yes
fontsize: 11pt
mainfont: Palatino
monofont: "Source Code Pro"
monofontoptions: "Scale=0.8"
github-repo: https://github.com/biodiversitydata-se/r-tools-tutorial
cover-image: images/SBDI.png
---
```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```

# Introduction

[TO BE UPDATED] Each research question draws its own challenges which are unique in themselves. Our aim here is to provide a workflow which answers and / or prompts the large scale questions that should be asked at each stage of the process. We point to resources, methods and facilities that may be useful in answering a particular question. We assume some knowledge of statistical inference and it limitations. The validity and appropriateness of a particular method is dependent on the individual researcher(s). This workflow is focused on the statistical programming language R, as an environment where the complete analysis workflow can take place and can be documented in a fully reproducible way. However, we also point to other tools that can be used at different stages, and ways to import and export the data from and to those tools.

Biodiversity resources are increasingly international. We focus on biodiversity data and resources from Sweden but our aim is to present considerations and methods that can be applied beyond Sweden's borders.

General description of the workflow here. Data--\>Cleaning--\>Fitness evaluation--\>Analysis always exploring and filtering the data in light of the research question. Also say here that if known from before, the cleaning and filtering criteria can be set directly on the query!

`r htmltools::includeHTML("images/Workflow Overview Horizontal.html")`

The SBDI4R package is primarily for accessing data. It includes some filter functions that allow you to filter prior to download. It also includes some simple summary functions, and some function for some simple data exploration. The examples also show you how you can use the data by continued exploring and analysing using other R package.

Please get in contact with us if you have questions regarding the use of the SBDI4R package.

## Using SBDI4R

Lets assume you have already installed the package as shown in the main site \url{https://biodiversitydata-se.github.io/SBDI4R}.

The SBDI4R package must be loaded for each new R session:

```{r, message=FALSE}
library(SBDI4R)
sbdi_config(caching="off")
```

However, the options you stored in .Rprofile if you did it so, will load automatically with the package.

Then, check that we have some additional packages that we'll use in the examples, and install them if necessary.

```{r, message=FALSE}
to_install <- c("ape", "dplyr", "ggplot2", "jpeg", "leaflet","maps", "mapdata",
                "maptools", "phytools", "sp", "rgeos", "tidyr", "vegan")
to_install <- to_install[!sapply(to_install, requireNamespace, quietly=TRUE)]
if(length(to_install)>0)
    install.packages(to_install, repos="http://cran.us.r-project.org")
```

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```
# Installation:

get installation data from package

<!--chapter:end:01-installation.Rmd-->

```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```
# Case 1: Example with fish data from NORS

In this example we are interested in exploring data from a specific data resource -- Sjöprovfiskedatabasen NORS (Institutionen för akvatiska resurser, SLU). This data base has 2.8 M observations starting in the 1950's.

As you may already know, SBDI is a collection of many biodiversity databases. We start by searching for the data resource we are interested in using the function `pick_filter()`. This is an interactive query guiding you through the many resources available to filtering your query (data resources, spatial layers, and curated species lists).

```{r, message=FALSE, eval=FALSE}
fq_str <- pick_filter("resource") 
## follow the instructions 
```

Follow the instruction. Your choices here would have been "in3" --\> "dr20". Your variable `fq_str` will now contain a string "data_resource_uid:dr20".

```{r}
## we cant do it interactive here so we force it
fq_str <- "data_resource_uid:dr20"
```

But we are not interested in the complete database, but on the last 10 years of data. for this we concatenate (add to a vector) another filter string. These will be treated as AND factors.

```{r}
y1 <- 2012
y2 <- 2021
fq_str <- c(fq_str,paste0("year:[", y1, " TO ", y2,"]"))
## Note the square brakets are hard limits
```

For references on how to use the filters see documentation at [docs](link).

Using the function `occurrences()` we can the query for the observations fulfilling our filter. If you haven't specified that in the `sbdi_config()` before (see [Case 1: Example with fish data from NORS] Installation), you need to pass your email and the download reason.

```{r getOcc, cache=TRUE}
xf <- occurrences(fq = fq_str,
                 email = "test@test.org", 
                 download_reason_id=10)

## Simply summarise all records by data source 
table(xf$data$dataResourceName)
```

## Plotting data on a map

You can quickly plot all the observations as a PDF file with the function `ocurrence_plot()`, one page per species:

```{r pdf_plot, eval=FALSE}
occurrences_plot(x, "obsPlot.pdf", 
                 grouped=FALSE, 
                 taxon_level="species", 
                 pch='+')
```

Note that the plot is saved to a pdf file in the current working directory. You can find that with `getwd()`.

#### Leaflet

There are many other ways of producing spatial plots in R. The leaflet package provides a simple method of producing browser-based maps with panning, zooming, and background layers:

```{r leaflet, message=FALSE, warning=FALSE}
library(leaflet)
## drop any records with missing lat/lon values
xfl <- xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),] 
marker_colour <- rep("#d95f02", nrow(xfl))
## blank map, with imagery background
leaflet(width = "100%") %>% 
  addProviderTiles("Esri.WorldImagery") %>% 
  ## add markers
  addCircleMarkers(xfl$longitude, xfl$latitude,  
                   radius = 1, 
                   fillOpacity =.5, 
                   opacity = 1,
                   col=marker_colour,
                  clusterOptions = markerClusterOptions())
```

## Temporal analysis

A quick summary over the years reveal a drop in number of records over time, and stops .

```{r}
table(xf$data$year)
```

```{r}
hist(xf$data$year, 
     breaks = seq(y1, y2), 
     xlab = "Year", 
     main = "")
```

## Species summary

In the same way we can summaries the number of observations for each species, by common or scientific name.

```{r nObsTab, paged.print=TRUE}
sppTab <- table(xf$data$commonName)
sppDF <- as.data.frame(sppTab)
colnames(sppDF)[1] <- "species"
sppDF
```

```{r nObsTab2, paged.print=TRUE}
sppTab <- table(xf$data$scientificName)
sppDF <- as.data.frame(sppTab)
colnames(sppDF)[1] <- "species"
sppDF
```

Perhaps, you need to send this table as a .CSV file to a colleague.

```{r, eval=FALSE}
write.csv(sppDF, "NORS species summary.csv")
## Note, again this will be saved on your working directory
```

## Spatial biodiversity analysis

Let's now ask: how does the species richness vary across Sweden? In this case we want to summarise occurrences species-wise over a defined grid instead of plotting every observation point. First we need to overlay the observations with a grid. In this case, the standard Swedish grids at 50, 25, 10 and 5 km are provided as data in the SBDI4R package (with Coordinate Reference System = WGS84, EPSG:4326).

```{r overlay}
library(sp) # the function coordinates() and proj4string() are in sp
library(rgeos) # the function over() is in package rgeos
# load some shapes over Sweden's political borders
data("swe_wgs84", package="SBDI4R", envir=environment())
# A standard 50km grid
data("Sweden_Grid_50km_Wgs84", package="SBDI4R", envir=environment())

grid <- Sweden_Grid_50km_Wgs84
grid <- spTransform(grid, CRS("+init=epsg:4326")) # as mentioned above, the grid already has has the same CRS, but changes are undergoing in the sp package and this step is needed

# make the observations spatial
# NOTE: make sure there are no NAs on either column defining the coordinates
# xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),]

obs <- as.data.frame(xf$data)
coordinates(obs) <- obs[,c("longitude","latitude")]
proj4string(obs) <- CRS("+init=epsg:4326")

nObs <- nrow(obs)

# overlay the data with the grid
ObsInGridList <- over(grid, obs, returnList=TRUE)
wNonEmpty <- unname( which( unlist(lapply(ObsInGridList, nrow)) != 0) )
if(length(wNonEmpty)==0) message("Observations don't overlap any grid cell.")
```

The result `ObsInGridList` is a `list` object with a subset of the data on each grid. Now summarise occurrences within grid cells:

```{r overlay_summary}
# check n the total number of observations
sum(unlist(lapply(ObsInGridList, nrow)))

# apply a summary over the grid cells 
nCells <- length(ObsInGridList)

res <- data.frame("nObs"=as.numeric(rep(NA,nCells)),
                  "nYears"=as.numeric(rep(NA,nCells)),
                  "nSpp"=as.numeric(rep(NA,nCells)),
                  row.names = row.names(grid),
                  stringsAsFactors = FALSE)

cols2use <- c("scientificName", "year")

dataRes <- lapply(ObsInGridList[wNonEmpty], function(x){
  x <- x[,cols2use]
  colnames(x) <- c("scientificName", "year")
  return(c("nObs" = length(x[,"scientificName"]),
           "nYears" = length(unique(x[,"year"])),
           "nSpp" = length(unique(x[,"scientificName"]))
           ))
  })

dataRes <- as.data.frame(dplyr::bind_rows(dataRes, .id = "gridID"))

res[wNonEmpty,] <- dataRes[,-1]

resSp <- sp::SpatialPolygonsDataFrame(grid, res)
```

And finally plot the grid summary as a map:

```{r grid, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
palBW <- leaflet::colorNumeric(c("white", "navyblue"),
                               c(0, max(resSp@data$nSpp, na.rm = TRUE)),
                               na.color = "transparent")
oldpar <- par()
par(mar = c(1,1,0,0))
plot(resSp, col=palBW(resSp@data$nSpp), border = NA)
plot(swe_wgs84$Border, border=1, lwd=1, add=T)
legend("bottomleft", 
       legend = round(seq(0, max(resSp@data$nSpp, na.rm = TRUE), length.out = 5)),
       col = palBW(seq(0, max(resSp@data$nSpp, na.rm = TRUE), length.out = 5)),
       title = "Number of \nspecies", pch = 15, bty="n")
par(oldpar)
```

<!--chapter:end:02-fish-data.Rmd-->

```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```
# The importance of questions and sources of data

## Questions

Any question to be asked of biodiversity data should be put as simply and succinctly as possible. With the number of different subject areas and techniques used, analyses can quickly become complex.

## Taxonomies

It is important to be aware of likely taxonomic anomalies prior to working within a region. Checklists are very important, especially if working over several regions / countries. Whilst there are many things that will automatically look for the validity of a name they do not check for the validity of that species occurrence. For example *Sphagnum auriculatum* and *S. denticulatum* are both valid names. *S. auriculatum* is the currently accepted species in Europe but in the British Isles, Ireland and the Netherlands *s. denticulatum* is the most recorded taxa. Using data from across the European region without acknowledging this disagreement would impact the results of any research undertaken. For taxa which are known to be capable of dispersing great distances (eg birds) this becomes even more difficult especially when using community sourced data.

For Sweden there is an agreed taxonomy for species accesible through [<https://www.dyntaxa.se/>] and the R library **dyntaxa**.

## Data Sources

Depending on what questions are being asked there are many different resources available. We focus on biodiversity data

### Biodiversity record data

-   Artportalen [<https://www.artportalen.se/>] - Sweden's data portal for biodiversity data
-   Global Biodiversity Information Facility [<http://www.gbif.org/>] - International organization aggregating biodiversity data. Contains data from a mixture of sources; curated collections, community science data, ecological research projects etc. **rgbif, spocc**
-   BioCASE [<https://www.biocase.org/>] - A European transnational biodiversity repository
-   eBird [<http://ebird.org/content/ebird/>] - American database of bird observations **auk, rebird,spocc**
-   iNaturalist <http://www.inaturalist.org/> - International community science observation repository **spocc**
-   Berkeley ecoengine [<https://ecoengine.berkeley.edu>] - Access to UC Berkley's Natural history data **spocc**
-   VertNet [<http://vertnet.org/>] - vertebrate biodiversity collections **rvert, spocc**
-   iDigBio [<https://www.idigbio.org/>] - Integrated digitise biodiversity collections **ridigbio**
-   OBIS [<http://www.iobis.org/>] - Ocean biodiversity information system **robis**
-   ALA [<http://www.ala.org.au/>] - Atlas of living Australia **ALA4r**
-   Neotoma [<https://www.neotomadb.org/>] Palaeoecology databas **neotoma**
-   ...

<!--chapter:end:03-dragonflies-data.Rmd-->

```{r include=FALSE, cache=FALSE}

knitr::opts_knit$set(root.dir = here::here())
set.seed(1)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  out.width = "\\textwidth", 
  fig.align = "center",
  fig.width = 7,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)
options(knitr.kable.NA = "",
        dplyr.print_min = 6, dplyr.print_max = 6,
        htmltools.dir.version = FALSE, formatR.indent = 2,
        # width = 72, 
        digits = 4, 
        # widgetframe_widgets_dir = 'widgets',
        warnPartialMatchAttr = FALSE,
        warnPartialMatchDollar = FALSE)

lapply(c('xfun'), function(pkg) {
  if (system.file(package = pkg) == '') install.packages(pkg)
})
```
`r if (knitr:::is_html_output()) ' # References {-} '`

<!--chapter:end:04-references.Rmd-->

