% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames*,x11names*}{xcolor}
%
\documentclass[
  10pt,
]{article}
\usepackage{lmodern}
\usepackage{amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
  \usepackage{amssymb}
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Using R tools for analysis  of primary biodiversity data provided by SBDI},
  pdfauthor={Debora Arlt and Alejandro Ruete  for the Swedish Biodiversity Data Infrastructure},
  colorlinks=true,
  linkcolor=Maroon,
  filecolor=Maroon,
  citecolor=Blue,
  urlcolor=Blue,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{apalike}

\title{Using R tools for analysis of primary biodiversity data provided by SBDI}
\author{Debora Arlt and Alejandro Ruete for the Swedish Biodiversity Data Infrastructure}
\date{2021-05-31}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\hypertarget{introduction}{%
\section*{Introduction}\label{introduction}}
\addcontentsline{toc}{section}{Introduction}

Biodiversity resources are increasingly international. The SBDI has made an effort to canalize biodiversity data and resources to help the research community access and analyze Swedish primary biodiversity data. Each research question draws its own challenges which are unique in themselves. Our aim here is to provide a few examples that prompt questions that may be asked at different stages of the process. The validity and appropriateness of a particular method depends on the individual researcher(s). For a comprehensive workflow on how to treat and analyze PBD please refer to our tutorial on \href{https://github.com/biodiversitydata-se/biodiversity-analysis-tools}{biodiversity analysis tool} where we go through the complete workflow Data --\textgreater{} Cleaning --\textgreater{} Fitness evaluation --\textgreater{} Analysis

\hypertarget{r-and-mirroreum}{%
\subsection*{R and Mirroreum}\label{r-and-mirroreum}}
\addcontentsline{toc}{subsection}{R and Mirroreum}

The present tutorial is focused on the statistical programming language R. R is a free software environment for statistical computing and graphics that is widely used within the scientific community and where the complete analysis workflow can be documented in a fully reproducible way.

At SBDI we provide access for researchers and students to \href{https://mirroreum.biodiversitydata.se/}{Mirroreum} -- an online web-based environment for Reproducible Open Research in the area of biodiversity analysis. Mirroreum is based on a Free and Open Source stack of software. Logging in, you immediately get access to a web-based version of R Studio with a large number of pre-installed packages such as all the packages offered from ROpenSci and more.

Compared to running R Studio on your own machine, Mirroreum offers more computational resources and a standardized environment where you can rely on all the relevant packages being installed and the configuration parameters being set appropriately. To know more about Mirroreum or to request an account please visit the \href{https://docs.biodiversitydata.se/analyse-data/mirroreum/}{SBDI documentation site}

\href{https://mirroreum.biodiversitydata.se/auth-sign-in}{\includegraphics{images/Mirroreum.png}}

\hypertarget{sbdi4r---an-r-to-search-an-access-data}{%
\subsection*{SBDI4R - an R ðŸ“¦ to search an access data}\label{sbdi4r---an-r-to-search-an-access-data}}
\addcontentsline{toc}{subsection}{SBDI4R - an R ðŸ“¦ to search an access data}

The SBDI4R package enables the R community to directly access data and resources hosted by SBDI. The goal is to enable observations of species to be queried and output in a range of standard formats. It includes some filter functions that allow you to filter prior to download. It also includes some simple summary functions, and some function for some simple data exploration. The examples included in this tutorial also show you how you can continue exploring and analyzing using other R package.

Please refer to the \href{https://biodiversitydata-se.github.io/SBDI4R}{package documentation} for details on how to install it. Once installed the SBDI4R package must be loaded for each new R session:

\begin{verbatim}
## Warning: package 'sp' was built under R version 4.0.4
\end{verbatim}

\hypertarget{customizing-sbdi4r}{%
\subsubsection*{Customizing SBDI4R}\label{customizing-sbdi4r}}
\addcontentsline{toc}{subsubsection}{Customizing SBDI4R}

Various aspects of the SBDI4R package can be customized.

\hypertarget{caching}{%
\paragraph*{Caching}\label{caching}}
\addcontentsline{toc}{paragraph}{Caching}

SBDI4R can cache most results to local files. This means that if the same code is run multiple times, the second and subsequent iterations will be faster. This will also reduce load on the web servers. By default, this caching is session-based, meaning that the local files are stored in a temporary directory that is automatically deleted when the R session is ended. This behaviour can be altered so that caching is permanent, by setting the caching directory to a non-temporary location. For example, under Windows, use something like:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{cache\_directory =} \FunctionTok{file.path}\NormalTok{(}\StringTok{"c:"}\NormalTok{,}\StringTok{"mydata"}\NormalTok{,}\StringTok{"sbdi\_cache"}\NormalTok{)) }\DocumentationTok{\#\# Windows}
\end{Highlighting}
\end{Shaded}

or for Linux:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{cache\_directory =} \StringTok{"\textasciitilde{}/mydata/sbdi\_cache"}\NormalTok{) }\DocumentationTok{\#\# Linux}
\end{Highlighting}
\end{Shaded}

Note that this directory must exist (you need to create it yourself).

All results will be stored in that cache directory and will be used from one session to the next. They won't be re-downloaded from the server unless the user specifically deletes those files or changes the caching setting to ``refresh''.

If you change the cache\_directory to a permanent location, you may wish to add something like this to your .Rprofile file, so that it happens automatically each time the SBDI4R package is loaded:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{setHook}\NormalTok{(}\FunctionTok{packageEvent}\NormalTok{(}\StringTok{"SBDI4R"}\NormalTok{, }\StringTok{"onLoad"}\NormalTok{), }
        \ControlFlowTok{function}\NormalTok{(...) }\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{cache\_directory=}\FunctionTok{file.path}\NormalTok{(}\StringTok{"\textasciitilde{}"}\NormalTok{,}\StringTok{"mydata"}\NormalTok{,}\StringTok{"sbdi\_cache"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

Caching can also be turned off entirely by:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{caching=}\StringTok{"off"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

or set to ``refresh'', meaning that the cached results will re-downloaded from the SBDI servers and the cache updated. (This will happen for as long as caching is set to ``refresh'' --- so you may wish to switch back to normal ``on'' caching behavior once you have updated your cache with the data you are working on).

\hypertarget{e-mail-address}{%
\paragraph*{E-mail address}\label{e-mail-address}}
\addcontentsline{toc}{paragraph}{E-mail address}

Each download request to SBDI servers is also accompanied by an ``e-mail address'' string that identifies the user making the request. You will need to provide an email address registered with the SBDI. You can create an account \href{https://auth.biodiversitydata.se/cas/login}{here}. Once an email is registered with the SBDI, it should be stored in the config:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{email=}\StringTok{"your.valid@emailaddress.com"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Else you can provide this e-mail address as a parameter directly to each call of the function occurrences().

\hypertarget{setting-the-download-reason}{%
\paragraph*{Setting the download reason}\label{setting-the-download-reason}}
\addcontentsline{toc}{paragraph}{Setting the download reason}

SBDI requires that you provide a reason when downloading occurrence data (via the SBDI4R \texttt{occurrences()} function). You can provide this as a parameter directly to each call of \texttt{occurrences()}, or you can set it once per session using:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{download\_reason\_id =} \StringTok{"your\_reason\_id"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

(See \texttt{sbdi\_reasons()} for valid download reasons, e.g.~* 3 for ``education'', * 7 for ``ecological research'', * 8 for ``systematic research/taxonomy'', * 10 for ``testing'')

\hypertarget{privacy}{%
\paragraph{Privacy}\label{privacy}}

\textbf{\emph{NO}} other personal identification information is sent. You can see all configuration settings, including the the user-agent string that is being used, with the command:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{other-options}{%
\paragraph*{Other options}\label{other-options}}
\addcontentsline{toc}{paragraph}{Other options}

If you make a request that returns an empty result set (e.g.~an un-matched name), by default you will simply get an empty data structure returned to you without any special notification. If you would like to be warned about empty result sets, you can use:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sbdi\_config}\NormalTok{(}\AttributeTok{warn\_on\_empty=}\ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{other-packages-needed}{%
\subsection*{Other packages needed}\label{other-packages-needed}}
\addcontentsline{toc}{subsection}{Other packages needed}

Some additional packages are needed for these examples. Install them if necessary with the following script.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{to\_install }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"BIRDS"}\NormalTok{,}\StringTok{"colorRamps"}\NormalTok{, }\StringTok{"cowplot"}\NormalTok{,}\StringTok{"dplyr"}\NormalTok{,}\StringTok{"ggplot2"}\NormalTok{, }
                \StringTok{"leaflet"}\NormalTok{, }\StringTok{"maps"}\NormalTok{, }\StringTok{"mapdata"}\NormalTok{, }\StringTok{"maptools"}\NormalTok{, }\StringTok{"sf"}\NormalTok{, }\StringTok{"sp"}\NormalTok{,}
                \StringTok{"rgeos"}\NormalTok{, }\StringTok{"tidyr"}\NormalTok{, }\StringTok{"xts"}\NormalTok{)}
\NormalTok{to\_install }\OtherTok{\textless{}{-}}\NormalTok{ to\_install[}\SpecialCharTok{!}\FunctionTok{sapply}\NormalTok{(to\_install, }
\NormalTok{                                 requireNamespace, }
                                 \AttributeTok{quietly=}\ConstantTok{TRUE}\NormalTok{)]}
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(to\_install)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)}
    \FunctionTok{install.packages}\NormalTok{(to\_install, }
                     \AttributeTok{repos=}\StringTok{"http://cran.us.r{-}project.org"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{your-collaboration-is-appreciated}{%
\subsection*{Your collaboration is appreciated}\label{your-collaboration-is-appreciated}}
\addcontentsline{toc}{subsection}{Your collaboration is appreciated}

Open Source also means that you can contribute. You don't need to know how to program but every input is appreciated. Did you find something that is not working? Have suggestions for examples or text? you can always

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Reach to us via the \href{https://docs.biodiversitydata.se/support/}{support center}
\item
  Submit and issue to the GitHub code repository \href{https://docs.github.com/en/github/managing-your-work-on-github/managing-your-work-with-issues-and-pull-requests/creating-an-issue}{see how}
\item
  Or contribute with your code or documents modifications by \href{https://docs.github.com/en/github/getting-started-with-github/quickstart/fork-a-repo}{``forking''} the code and submitting a \href{https://docs.github.com/en/github/collaborating-with-issues-and-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork}{``pull request''}
\end{enumerate}

The repositories you can contribute to are:

\begin{itemize}
\tightlist
\item
  Mirroreum \url{https://github.com/mskyttner/mirroreum}\\
\item
  SBDI4R \url{https://github.com/biodiversitydata-se/SBDI4R} (NOTE: we may not develop this package but instead move to a new one)\\
\item
  the general analysis workflows \url{https://github.com/biodiversitydata-se/biodiversity-analysis-tools}\\
\item
  these tutorial \url{https://github.com/biodiversitydata-se/r-tools-tutorial}
\end{itemize}

\hypertarget{example-with-fish-data-from-sers}{%
\section{Example with fish data from SERS}\label{example-with-fish-data-from-sers}}

In this example we are interested in exploring data from a specific data resource -- Swedish Electrofishing Registry - SERS (Institutionen fÃ¶r akvatiska resurser, SLU). This data base has 2.8 M observations starting in the 1950's.

As you may already know, SBDI is a collection of many biodiversity databases. We start by searching for the data resource we are interested in using the function \texttt{pick\_filter()}. This is an interactive query guiding you through the many resources available to filtering your query (data resources, spatial layers, and curated species lists).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(SBDI4R)}
\NormalTok{fq\_str }\OtherTok{\textless{}{-}} \FunctionTok{pick\_filter}\NormalTok{(}\StringTok{"resource"}\NormalTok{) }
\CommentTok{\# follow the instructions }
\end{Highlighting}
\end{Shaded}

Follow the instruction. Your choices here would have been ``in3'' --\textgreater{} ``dr10''. Your variable \texttt{fq\_str} will now contain a string ``data\_resource\_uid:dr10''.

But we are not interested in the complete database, but on the last 10 years of data. for this we concatenate (add to a vector) another filter string. These will be treated as AND factors.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y1 }\OtherTok{\textless{}{-}} \DecValTok{2008}
\NormalTok{y2 }\OtherTok{\textless{}{-}} \DecValTok{2012}
\NormalTok{fq\_str }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(fq\_str, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"year:["}\NormalTok{, y1, }\StringTok{" TO "}\NormalTok{, y2,}\StringTok{"]"}\NormalTok{))}
\CommentTok{\# Note the square brackets are hard limits}
\end{Highlighting}
\end{Shaded}

For references on how to use the filters see SBDI APIS \href{https://api.biodiversitydata.se/?lang=en-US\#ws3}{documentation}.

Using the function \texttt{occurrences()} we can the query for the observations fulfilling our filter. If you haven't specified that in the \texttt{sbdi\_config()} before, you need to pass your email and the download reason.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xf }\OtherTok{\textless{}{-}}\NormalTok{ SBDI4R}\SpecialCharTok{::}\FunctionTok{occurrences}\NormalTok{(}\AttributeTok{fq =}\NormalTok{ fq\_str,}
                 \AttributeTok{email =} \StringTok{"sbdi4r{-}test@biodiversitydata.se"}\NormalTok{, }
                 \AttributeTok{download\_reason\_id =} \DecValTok{10}\NormalTok{)}

\CommentTok{\# Remove what is not a species}
\NormalTok{xf}\SpecialCharTok{$}\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ xf}\SpecialCharTok{$}\NormalTok{data[xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{rank }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"species"}\NormalTok{, }\StringTok{"subspecies"}\NormalTok{, }\StringTok{"variety"}\NormalTok{, }\StringTok{"form"}\NormalTok{, }\StringTok{"cultivar"}\NormalTok{),]}

\CommentTok{\# Simply summarise all records by data source }
\FunctionTok{table}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{dataResourceName, xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{dataResourceID)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                                                                    
##                                                                                      dr10
##   SLU Aqua  Institute of Freshwater Research Swedish Electrofishing Registry - SERS 93205
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{dataResourceID)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  dr10 
## 93205
\end{verbatim}

\hypertarget{plotting-data-on-a-map}{%
\subsection{Plotting data on a map}\label{plotting-data-on-a-map}}

You can quickly plot all the observations as a PDF file with the function \texttt{ocurrence\_plot()}, one page per species:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{occurrences\_plot}\NormalTok{(xf, }\StringTok{"obsPlot.pdf"}\NormalTok{, }
                 \AttributeTok{grouped=}\ConstantTok{FALSE}\NormalTok{, }
                 \AttributeTok{taxon\_level=}\StringTok{"species"}\NormalTok{, }
                 \AttributeTok{pch=}\StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Note that the plot is saved to a pdf file in the current working directory. You can find that with \texttt{getwd()}.

\hypertarget{leaflet}{%
\paragraph{Leaflet}\label{leaflet}}

There are many other ways of producing spatial plots in R. The leaflet package provides a simple method of producing browser-based maps with panning, zooming, and background layers:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(leaflet)}
\CommentTok{\# drop any records with missing lat/lon values}
\NormalTok{xfl }\OtherTok{\textless{}{-}}\NormalTok{ xf}\SpecialCharTok{$}\NormalTok{data[}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{longitude) }\SpecialCharTok{|} \SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{latitude),] }
\NormalTok{marker\_colour }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\StringTok{"\#d95f02"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(xfl))}
\CommentTok{\# blank map, with imagery background}
\FunctionTok{leaflet}\NormalTok{(}\AttributeTok{width =} \StringTok{"100\%"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{addProviderTiles}\NormalTok{(}\StringTok{"Esri.WorldImagery"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \CommentTok{\# add markers}
  \FunctionTok{addCircleMarkers}\NormalTok{(xfl}\SpecialCharTok{$}\NormalTok{longitude, xfl}\SpecialCharTok{$}\NormalTok{latitude,  }
                   \AttributeTok{radius =} \DecValTok{1}\NormalTok{, }
                   \AttributeTok{fillOpacity =}\NormalTok{.}\DecValTok{5}\NormalTok{, }
                   \AttributeTok{opacity =} \DecValTok{1}\NormalTok{,}
                   \AttributeTok{col=}\NormalTok{marker\_colour,}
                  \AttributeTok{clusterOptions =} \FunctionTok{markerClusterOptions}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\includegraphics{r-tools-tutorial_files/figure-latex/leaflet-1.pdf}

\hypertarget{temporal-summary}{%
\subsection{Temporal summary}\label{temporal-summary}}

A quick summary over the years reveal a drop in number of records over time.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{year)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  2008  2009  2010  2011  2012 
## 17757 19300 19648 16853 19647
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{year, }
     \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(y1, y2), }
     \AttributeTok{xlab =} \StringTok{"Year"}\NormalTok{, }
     \AttributeTok{main =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{r-tools-tutorial_files/figure-latex/timeHist-1.pdf}

\hypertarget{species-summary}{%
\subsection{Species summary}\label{species-summary}}

In the same way we can summaries the number of observations for each species, by common or scientific name.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sppTab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{commonName)}
\NormalTok{sppDF }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(sppTab)}
\FunctionTok{colnames}\NormalTok{(sppDF)[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"species"}
\FunctionTok{head}\NormalTok{(sppDF)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           species Freq
## 1                   66
## 2 Alpine bullhead 4615
## 3 American burbot 7081
## 4        Aral asp    6
## 5     Arctic char   46
## 6    aurora trout  856
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sppTab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data}\SpecialCharTok{$}\NormalTok{scientificName)}
\NormalTok{sppDF }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(sppTab)}
\FunctionTok{colnames}\NormalTok{(sppDF)[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"species"}
\FunctionTok{head}\NormalTok{(sppDF)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                species Freq
## 1       Abramis brama (Linnaeus, 1758)   61
## 2   Alburnus alburnus (Linnaeus, 1758)  660
## 3   Anguilla anguilla (Linnaeus, 1758) 2140
## 4     Astacus astacus (Linnaeus, 1758)  618
## 5 Barbatula barbatula (Linnaeus, 1758)  620
## 6     Blicca bjoerkna (Linnaeus, 1758)   74
\end{verbatim}

Perhaps, you need to send this table as a .CSV file to a colleague.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{write.csv}\NormalTok{(sppDF, }\StringTok{"SERS\_species\_summary.csv"}\NormalTok{)}
\CommentTok{\# }\AlertTok{NOTE}\CommentTok{: again this will be saved on your working directory}
\end{Highlighting}
\end{Shaded}

\hypertarget{spatial-biodiversity-analysis}{%
\subsection{Spatial biodiversity analysis}\label{spatial-biodiversity-analysis}}

Let's now ask: how does the species richness vary across Sweden? In this case we
want to summarise occurrences species-wise over a defined grid instead of plotting
every observation point. First we need to overlay the observations with a grid.
In this case, the standard Swedish grids at 50, 25, 10 and 5 km are provided as
data in the SBDI4R package (with Coordinate Reference System = WGS84, EPSG:4326).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sp) }\CommentTok{\# the function coordinates() and proj4string() are in sp}
\FunctionTok{library}\NormalTok{(rgeos) }\CommentTok{\# the function over() is in package rgeos}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'rgeos' was built under R version 4.0.4
\end{verbatim}

\begin{verbatim}
## rgeos version: 0.5-5, (SVN revision 640)
##  GEOS runtime version: 3.8.0-CAPI-1.13.1 
##  Linking to sp version: 1.4-5 
##  Polygon checking: TRUE
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# load some shapes over Sweden\textquotesingle{}s political borders}
\FunctionTok{data}\NormalTok{(}\StringTok{"swe\_wgs84"}\NormalTok{, }\AttributeTok{package=}\StringTok{"SBDI4R"}\NormalTok{, }\AttributeTok{envir=}\FunctionTok{environment}\NormalTok{())}
\CommentTok{\# A standard 50km grid}
\FunctionTok{data}\NormalTok{(}\StringTok{"Sweden\_Grid\_50km\_Wgs84"}\NormalTok{, }\AttributeTok{package=}\StringTok{"SBDI4R"}\NormalTok{, }\AttributeTok{envir=}\FunctionTok{environment}\NormalTok{())}

\NormalTok{grid }\OtherTok{\textless{}{-}}\NormalTok{ Sweden\_Grid\_50km\_Wgs84}

\CommentTok{\# make the observations spatial}
\CommentTok{\# }\AlertTok{NOTE}\CommentTok{: make sure there are no NAs on either column defining the coordinates}
\CommentTok{\# xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),]}

\NormalTok{obs }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data)}
\FunctionTok{coordinates}\NormalTok{(obs) }\OtherTok{\textless{}{-}}\NormalTok{ obs[,}\FunctionTok{c}\NormalTok{(}\StringTok{"longitude"}\NormalTok{,}\StringTok{"latitude"}\NormalTok{)]}
\NormalTok{wkt }\OtherTok{\textless{}{-}}\NormalTok{ sf}\SpecialCharTok{::}\FunctionTok{st\_crs}\NormalTok{(}\DecValTok{4326}\NormalTok{)[[}\DecValTok{2}\NormalTok{]]}
\FunctionTok{proj4string}\NormalTok{(obs) }\OtherTok{\textless{}{-}}\NormalTok{ sp}\SpecialCharTok{::}\FunctionTok{CRS}\NormalTok{(wkt) }\CommentTok{\#CRS("+init=epsg:4326")}

\NormalTok{nObs }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(obs)}

\CommentTok{\# overlay the data with the grid}
\NormalTok{ObsInGridList }\OtherTok{\textless{}{-}} \FunctionTok{over}\NormalTok{(grid, obs, }\AttributeTok{returnList=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{wNonEmpty }\OtherTok{\textless{}{-}} \FunctionTok{unname}\NormalTok{( }\FunctionTok{which}\NormalTok{( }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(ObsInGridList, nrow)) }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{) )}
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(wNonEmpty)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\FunctionTok{message}\NormalTok{(}\StringTok{"Observations don\textquotesingle{}t overlap any grid cell."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The result \texttt{ObsInGridList} is a \texttt{list} object with a subset of the data on each grid. Now summarise occurrences within grid cells:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# check n the total number of observations}
\FunctionTok{sum}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(ObsInGridList, nrow)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 93205
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# apply a summary over the grid cells }
\NormalTok{nCells }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(ObsInGridList)}

\NormalTok{res }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\StringTok{"nObs"}\OtherTok{=}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,nCells)),}
                  \StringTok{"nYears"}\OtherTok{=}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,nCells)),}
                  \StringTok{"nSpp"}\OtherTok{=}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{,nCells)),}
                  \AttributeTok{row.names =} \FunctionTok{row.names}\NormalTok{(grid),}
                  \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{cols2use }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"scientificName"}\NormalTok{, }\StringTok{"year"}\NormalTok{)}

\NormalTok{dataRes }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(ObsInGridList[wNonEmpty], }
                  \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{                    x }\OtherTok{\textless{}{-}}\NormalTok{ x[,cols2use]}
                    \FunctionTok{colnames}\NormalTok{(x) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"scientificName"}\NormalTok{, }\StringTok{"year"}\NormalTok{)}
                    \FunctionTok{return}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"nObs"} \OtherTok{=} \FunctionTok{length}\NormalTok{(x[,}\StringTok{"scientificName"}\NormalTok{]),}
                             \StringTok{"nYears"} \OtherTok{=} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(x[,}\StringTok{"year"}\NormalTok{])),}
                             \StringTok{"nSpp"} \OtherTok{=} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(x[,}\StringTok{"scientificName"}\NormalTok{]))}
\NormalTok{                             )}
\NormalTok{                           )}
\NormalTok{                    \}}
\NormalTok{                  )}

\NormalTok{dataRes }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(dataRes, }\AttributeTok{.id =} \StringTok{"gridID"}\NormalTok{))}

\NormalTok{res[wNonEmpty,] }\OtherTok{\textless{}{-}}\NormalTok{ dataRes[,}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{resSp }\OtherTok{\textless{}{-}}\NormalTok{ sp}\SpecialCharTok{::}\FunctionTok{SpatialPolygonsDataFrame}\NormalTok{(grid, res)}
\end{Highlighting}
\end{Shaded}

And finally plot the grid summary as a map:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{palBW }\OtherTok{\textless{}{-}}\NormalTok{ leaflet}\SpecialCharTok{::}\FunctionTok{colorNumeric}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"navyblue"}\NormalTok{),}
                               \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(resSp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\NormalTok{nSpp, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)),}
                               \AttributeTok{na.color =} \StringTok{"transparent"}\NormalTok{)}
\NormalTok{oldpar }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{()}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(resSp, }\AttributeTok{col=}\FunctionTok{palBW}\NormalTok{(resSp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\NormalTok{nSpp), }\AttributeTok{border =} \ConstantTok{NA}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(swe\_wgs84}\SpecialCharTok{$}\NormalTok{Border, }\AttributeTok{border=}\DecValTok{1}\NormalTok{, }\AttributeTok{lwd=}\DecValTok{1}\NormalTok{, }\AttributeTok{add=}\NormalTok{T)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{, }
       \AttributeTok{legend =} \FunctionTok{round}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(resSp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\NormalTok{nSpp, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{col =} \FunctionTok{palBW}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(resSp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\NormalTok{nSpp, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{title =} \StringTok{"Number of }\SpecialCharTok{\textbackslash{}n}\StringTok{species"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{bty=}\StringTok{"n"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(oldpar)}
\end{Highlighting}
\end{Shaded}

We can go further by gathering the observations by latitude.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(tidyr)}
\NormalTok{xgridded }\OtherTok{\textless{}{-}}\NormalTok{ xf}\SpecialCharTok{$}\NormalTok{data }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{longitude =} \FunctionTok{round}\NormalTok{(longitude }\SpecialCharTok{*} \DecValTok{4}\NormalTok{)}\SpecialCharTok{/}\DecValTok{4}\NormalTok{, }
           \AttributeTok{latitude =} \FunctionTok{round}\NormalTok{(latitude }\SpecialCharTok{*} \DecValTok{4}\NormalTok{)}\SpecialCharTok{/}\DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{group\_by}\NormalTok{(longitude,latitude) }\SpecialCharTok{\%\textgreater{}\%}
    \DocumentationTok{\#\# subset to vars of interest}
    \FunctionTok{select}\NormalTok{(longitude, latitude, species) }\SpecialCharTok{\%\textgreater{}\%}
    \DocumentationTok{\#\# take one row per cell per species (presence)}
    \FunctionTok{distinct}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
    \DocumentationTok{\#\# calculate species richness}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{richness=}\FunctionTok{n}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
    \DocumentationTok{\#\# convert to wide format (sites by species)}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{present=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{do}\NormalTok{(tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{data=}\NormalTok{.,  }
                          \AttributeTok{names\_from=}\NormalTok{species, }
                          \AttributeTok{values\_from=}\NormalTok{present, }
                          \AttributeTok{values\_fill=}\DecValTok{0}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{ungroup}\NormalTok{()}
\DocumentationTok{\#\# where a species was not present, it will have NA: convert these to 0}
\NormalTok{sppcols }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(xgridded),}
                   \FunctionTok{c}\NormalTok{(}\StringTok{"longitude"}\NormalTok{, }\StringTok{"latitude"}\NormalTok{, }\StringTok{"richness"}\NormalTok{))}
\NormalTok{xgridded }\OtherTok{\textless{}{-}}\NormalTok{ xgridded }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate\_at}\NormalTok{(sppcols, }\ControlFlowTok{function}\NormalTok{(z) }\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(z), }\DecValTok{0}\NormalTok{, z))}
\end{Highlighting}
\end{Shaded}

And plot it accordingly

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}

\FunctionTok{ggplot}\NormalTok{(xgridded, }\FunctionTok{aes}\NormalTok{(latitude, richness)) }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Latitude (Âº)"}\NormalTok{, }
       \AttributeTok{y =} \StringTok{"Species richness"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{lims}\NormalTok{(}\AttributeTok{y =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{20}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{theme\_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{r-tools-tutorial_files/figure-latex/plot_richLat-1.pdf}

\hypertarget{example-with-opportunistic-data-on-dragonflies}{%
\section{Example with opportunistic data on Dragonflies}\label{example-with-opportunistic-data-on-dragonflies}}

In this example we are interested in exploring opportunistically collected data
from the Swedish citizen science observation data portal - Artportalen.

\hypertarget{name-searching}{%
\subsection{Name searching}\label{name-searching}}

To begin, we want be sure there is an unequivocal way to find the species within
the order Odonata and nothing else, so let's search for it:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sx }\OtherTok{\textless{}{-}} \FunctionTok{search\_fulltext}\NormalTok{(}\StringTok{"odonata"}\NormalTok{)}
\NormalTok{sx}\SpecialCharTok{$}\NormalTok{data[, }\FunctionTok{c}\NormalTok{(}\StringTok{"guid"}\NormalTok{, }\StringTok{"scientificName"}\NormalTok{, }\StringTok{"rank"}\NormalTok{, }\StringTok{"occurrenceCount"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "https://species.biodiversitydata.se/ws/search.json?q=odonata&fq=idxtype%3ATAXON"
\end{verbatim}

\begin{verbatim}
##       guid                          scientificName    rank occurrenceCount
## 1  9829523  Odonata associated gemycircularvirus 1 species               0
## 2 10072832  Odonata associated gemycircularvirus 2 species               0
## 3  8062407 Bdellodes odonata Wallace & Mahon, 1976 species               0
## 4      789                                 Odonata   order          207680
## 5  7367071    Ramalina fastigiata var. odonata Hue variety               0
\end{verbatim}

We quickly see there that other taxonomic definitions appear too, but there is
only one order. Let's refine the search. To know which search fields we can use
to filter the search we use the function \texttt{sbdi\_fields(fields\_type\ =\ "general")}.
The search field we are looking for is ``order\_s''.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sx }\OtherTok{\textless{}{-}} \FunctionTok{search\_fulltext}\NormalTok{(}\AttributeTok{fq=}\StringTok{"order\_s:Odonata"}\NormalTok{, }\AttributeTok{page\_size =} \DecValTok{10}\NormalTok{)}
\NormalTok{sx}\SpecialCharTok{$}\NormalTok{data[, }\FunctionTok{c}\NormalTok{(}\StringTok{"scientificName"}\NormalTok{, }\StringTok{"rank"}\NormalTok{, }\StringTok{"occurrenceCount"}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "https://species.biodiversitydata.se/ws/search.json?fq=order_s%3AOdonata&fq=idxtype%3ATAXON&pageSize=10"
\end{verbatim}

\begin{verbatim}
##       guid                             scientificName  rank occurrenceCount
## 1  1429753                Gomphomacromia Brauer, 1864 genus               1
## 2  1426725               Austropetalia Tillyard, 1916 genus               0
## 3  4799335                 Sogjutella Pritykina, 1980 genus               0
## 4  4302686                    Neuragrion Karsch, 1891 genus               0
## 5  4799353              Xamenophlebia Pritykina, 1981 genus               0
## 6  1429769               Lauromacromia Geijskes, 1970 genus               0
## 7  1428195                     Sympetrum Newman, 1833 genus           27050
## 8  4798599 Corduliochlora Marinov & Seidenbusch, 2007 genus               0
## 9  1423625             Torrenticnemis Lieftinck, 1949 genus               0
## 10 1423468                  Cyanallagma Kennedy, 1920 genus               0
\end{verbatim}

Now we can download the taxonomic data (note that the search is case-sensitive):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tx }\OtherTok{\textless{}{-}} \FunctionTok{taxinfo\_download}\NormalTok{(}\StringTok{"order\_s:Odonata"}\NormalTok{, }
                       \AttributeTok{fields =} \FunctionTok{c}\NormalTok{(}\StringTok{"guid"}\NormalTok{, }\StringTok{"order\_s"}\NormalTok{,}\StringTok{"genus\_s"}\NormalTok{, }\StringTok{"specificEpithet\_s"}\NormalTok{, }
                                  \StringTok{"scientificName"}\NormalTok{,  }\StringTok{"canonicalName\_s"}\NormalTok{, }\StringTok{"rank"}\NormalTok{), }
                       \AttributeTok{verbose =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{tx }\OtherTok{\textless{}{-}}\NormalTok{ tx[tx}\SpecialCharTok{$}\NormalTok{rank }\SpecialCharTok{==} \StringTok{"species"} \SpecialCharTok{\&}\NormalTok{ tx}\SpecialCharTok{$}\NormalTok{genusS }\SpecialCharTok{!=} \StringTok{""}\NormalTok{,] }\DocumentationTok{\#\# restrict to species and not hybrids}
\end{Highlighting}
\end{Shaded}

Then you can save \texttt{tx} as the complete species list for later use.

\hypertarget{filter-the-search-to-get-the-observations}{%
\subsection{Filter the search to get the observations}\label{filter-the-search-to-get-the-observations}}

As usual we start by searching for the data resource we are interested in using
the function \texttt{pick\_filter()}. This is an interactive query guiding you through
the many resources available to filtering your query (data resources, spatial
layers, and curated species lists).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# follow the instructions }
\NormalTok{fq\_str }\OtherTok{\textless{}{-}} \FunctionTok{pick\_filter}\NormalTok{(}\StringTok{"resource"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

Follow the instruction. Your choices here would have been ``in3'' --\textgreater{} ``dr5''.
Your variable \texttt{fq\_str} will now contain a string ``data\_resource\_uid:dr5''.

We only need data from 2000 to 2010

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y1 }\OtherTok{\textless{}{-}} \DecValTok{2000}
\NormalTok{y2 }\OtherTok{\textless{}{-}} \DecValTok{2010}
\NormalTok{fq\_str }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(fq\_str, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"year:["}\NormalTok{, y1, }\StringTok{" TO "}\NormalTok{, y2,}\StringTok{"]"}\NormalTok{))}
\CommentTok{\# Note the square brackets are hard limits}
\end{Highlighting}
\end{Shaded}

We also need to filter spatially for Southern Sweden (\href{https://en.wikipedia.org/wiki/G\%C3\%B6taland}{GÃ¶taland}).

Vector spatial layers (eg. polygons) can be imported in a number of different ways.
SBDI APIs take as search input polygons in the s.k. WKT \href{https://www.geoapi.org/3.0/javadoc/org/opengis/referencing/doc-files/WKT.html}{Well Known Text}
format. So the first step is to load a vector layer and transform it into a WKT string.
You could instead use the data we kindly provided in the SBDI4R package \texttt{data("swe")}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data}\NormalTok{(}\StringTok{"swe"}\NormalTok{,}\AttributeTok{package =} \StringTok{"SBDI4R"}\NormalTok{)}

\NormalTok{wGotaland }\OtherTok{\textless{}{-}}\NormalTok{ swe}\SpecialCharTok{$}\NormalTok{Counties}\SpecialCharTok{$}\NormalTok{LnNamn }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"Blekinge"}\NormalTok{, }\StringTok{"Gotlands"}\NormalTok{, }\StringTok{"Hallands"}\NormalTok{, }
                                        \StringTok{"JÃ¶nkÃ¶pings"}\NormalTok{, }\StringTok{"Kalmar"}\NormalTok{, }\StringTok{"Kronobergs"}\NormalTok{, }
                                        \StringTok{"Ã–stergÃ¶tlands"}\NormalTok{, }\StringTok{"SkÃ¥ne"}\NormalTok{, }\StringTok{"VÃ¤stra GÃ¶talands"}\NormalTok{)}
\NormalTok{gotaland\_c }\OtherTok{\textless{}{-}}\NormalTok{ swe}\SpecialCharTok{$}\NormalTok{Counties[wGotaland,]}
\end{Highlighting}
\end{Shaded}

There are details about this polygon that we need to take care before. The WKT
string should not be too long to be accepted by the API service. Also, the polygon
we just got is projected in the coordinate system SWEREF99 TM, and the API service
only accepts coordinates in a geodesic coordinate system WGS84. Let's construct
the WKT string:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# transform the CRS}
\NormalTok{gotaland\_c }\OtherTok{\textless{}{-}}\NormalTok{ sf}\SpecialCharTok{::}\FunctionTok{as\_Spatial}\NormalTok{(}
\NormalTok{                sf}\SpecialCharTok{::}\FunctionTok{st\_transform}\NormalTok{(}
\NormalTok{                  sf}\SpecialCharTok{::}\FunctionTok{st\_as\_sf}\NormalTok{(gotaland\_c), }
                  \AttributeTok{crs =}\NormalTok{ sf}\SpecialCharTok{::}\FunctionTok{st\_crs}\NormalTok{(}\DecValTok{4326}\NormalTok{)}\SpecialCharTok{$}\NormalTok{wkt) )}

\CommentTok{\# disolve the counties into one polygon}
\NormalTok{gotaland }\OtherTok{\textless{}{-}}\NormalTok{ rgeos}\SpecialCharTok{::}\FunctionTok{gUnaryUnion}\NormalTok{(gotaland\_c)}

\CommentTok{\# extract the polygons coordinates}
\NormalTok{nPol }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(gotaland}\SpecialCharTok{@}\NormalTok{polygons[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{@}\NormalTok{Polygons) }
\NormalTok{lonlat }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{(p }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(nPol))\{}
\NormalTok{  lonlat[[p]] }\OtherTok{\textless{}{-}}\NormalTok{ gotaland}\SpecialCharTok{@}\NormalTok{polygons[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{@}\NormalTok{Polygons[[p]]}\SpecialCharTok{@}\NormalTok{coords}
\NormalTok{\}}
\NormalTok{lonlat }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, lonlat)}

\CommentTok{\# create a convex hull of the polygon to simplify the geometry and }
\CommentTok{\# reduce the length of the WKT string}
\NormalTok{gotaland\_ch }\OtherTok{\textless{}{-}} \FunctionTok{chull}\NormalTok{(lonlat)}
\NormalTok{lonlat }\OtherTok{\textless{}{-}}\NormalTok{ lonlat[}\FunctionTok{c}\NormalTok{(gotaland\_ch, gotaland\_ch[}\DecValTok{1}\NormalTok{]), ]}

\CommentTok{\# create WKT string}
\CommentTok{\# first join each lon{-}lat coordinate pair}
\NormalTok{wkt\_temp }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(lonlat, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(z) }\FunctionTok{paste}\NormalTok{(}\FunctionTok{round}\NormalTok{(z,}\DecValTok{4}\NormalTok{), }\AttributeTok{collapse=}\StringTok{" "}\NormalTok{))}
\CommentTok{\# now build the WKT string}
\NormalTok{wkt }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"MULTIPOLYGON((("}\NormalTok{, }\FunctionTok{paste}\NormalTok{(wkt\_temp, }\AttributeTok{collapse=}\StringTok{","}\NormalTok{), }\StringTok{")))"}\NormalTok{, }\AttributeTok{sep=}\StringTok{""}\NormalTok{)}
\CommentTok{\# }\AlertTok{NOTE}\CommentTok{: as of today, the SBDI APIs will only work properly if the polygon is }
\CommentTok{\# submitted as a MULTIPOLYGON}
\end{Highlighting}
\end{Shaded}

The WKT string the looks like this

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wkt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "MULTIPOLYGON(((18.9004 57.4401,18.867 57.3975,18.3725 57.0068,18.3004 56.9528,16.408 56.2023,14.1906 55.3856,13.3357 55.34,12.8163 55.3859,11.2534 58.3579,11.1316 58.9094,11.1314 59.0118,11.2114 59.0897,11.3157 59.1165,11.8203 59.2355,11.9483 59.2624,12.062 59.2716,12.231 59.2736,15.7938 59.0388,15.8431 59.025,19.2889 57.9904,19.3058 57.9689,18.9004 57.4401)))"
\end{verbatim}

\includegraphics{r-tools-tutorial_files/figure-latex/searchpoly-1.pdf}

Next, we download the observations using the command \texttt{occurrences()}, but be aware that
the search fields may not be the same as those use to search for taxa. We therefore
recommend using the function \texttt{sbdi\_fields("occurrence")}. Here see that the field
we need this time is ``order''.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xf }\OtherTok{\textless{}{-}}\NormalTok{ SBDI4R}\SpecialCharTok{::}\FunctionTok{occurrences}\NormalTok{(}\AttributeTok{taxon =} \StringTok{"order:Odonata"}\NormalTok{, }
                  \AttributeTok{fq =}\NormalTok{ fq\_str,}
                  \AttributeTok{wkt =}\NormalTok{ wkt,}
                  \AttributeTok{extra =} \StringTok{"collector"}\NormalTok{,}
                  \AttributeTok{email =} \StringTok{"sbdi4r{-}test@biodiversitydata.se"}\NormalTok{, }
                  \AttributeTok{download\_reason\_id =} \DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We have now downloaded the data locally and depending on your configuration this
will be cached on your computer. However, as the search and download could take
long, we recommend to anyhow save the data locally.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(xf, }\AttributeTok{file =} \StringTok{"an\_approprieted\_name.rdata"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"an\_approprieted\_name.rdata"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{quality-and-fit-for-use-check}{%
\subsection{Quality and fit-for-use check}\label{quality-and-fit-for-use-check}}

Before we can use the observation records we need to know if the observation
effort has varied over time and in space. For this we need to define field visits
i.e.~occasions at which an observer has sampled observations, and reconstruct them
(that is, assign each observation a visitUID). We do this using the package
\href{https://greensway.github.io/BIRDS/}{BIRDS}. We even want the data to be summarized
over a grid of 25 km (provided by the SBDI4R package). The following functions
will perform many different summaries at the same time. Please refer to the package
documentation for more detail.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(BIRDS)}
\NormalTok{OB }\OtherTok{\textless{}{-}} \FunctionTok{organiseBirds}\NormalTok{(xf}\SpecialCharTok{$}\NormalTok{data, }\AttributeTok{sppCol =} \StringTok{"species"}\NormalTok{ , }
                    \CommentTok{\# We only want observations identified at the species level}
                    \AttributeTok{taxonRankCol =} \StringTok{"rank"}\NormalTok{, }\AttributeTok{taxonRank =} \StringTok{"species"}\NormalTok{, }
                    \CommentTok{\# the visits are defined by collector and named locality}
                    \AttributeTok{idCols =} \FunctionTok{c}\NormalTok{(}\StringTok{"locality"}\NormalTok{, }\StringTok{"collector"}\NormalTok{), }
                    \AttributeTok{timeCols =} \FunctionTok{c}\NormalTok{(}\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{, }\StringTok{"day"}\NormalTok{), }
                    \AttributeTok{xyCols =}\FunctionTok{c}\NormalTok{(}\StringTok{"longitude"}\NormalTok{,}\StringTok{"latitude"}\NormalTok{) )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 252 observations did not match with the specified taxon rank and were removed.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# We don\textquotesingle{}t need the whole grid, just the piece that overlaps our searching polygon}
\NormalTok{gotaland\_grid25 }\OtherTok{\textless{}{-}}\NormalTok{ raster}\SpecialCharTok{::}\FunctionTok{intersect}\NormalTok{(gotaland, Sweden\_Grid\_25km\_Wgs84)}

\CommentTok{\# This is another way of doing it.}
\CommentTok{\# gotaland\_grid25 \textless{}{-} gIntersection(gotaland,}
\CommentTok{\#                                  spTransform(Sweden\_Grid\_25km\_Wgs84, }
\CommentTok{\#                                              CRSobj = CRS(sf::st\_crs(4326)$wkt)))}

\NormalTok{SB }\OtherTok{\textless{}{-}} \FunctionTok{summariseBirds}\NormalTok{(OB, }\AttributeTok{grid =}\NormalTok{ gotaland\_grid25, }\AttributeTok{spillOver =} \StringTok{"unique"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 1664 observations did not overlap with the grid and will be discarded.
\end{verbatim}

\begin{verbatim}
## 0.009 % of the visits spill over neighbouring grid cells.
\end{verbatim}

Once summarized, we can see over space and for a few selected year how was the
sampling effort (in this case number of observations) distributed.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{maxC }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(SB}\SpecialCharTok{$}\NormalTok{spatial}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\NormalTok{nObs, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{palBW }\OtherTok{\textless{}{-}}\NormalTok{ leaflet}\SpecialCharTok{::}\FunctionTok{colorNumeric}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"navyblue"}\NormalTok{), }
                               \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC), }
                               \AttributeTok{na.color =} \StringTok{"transparent"}\NormalTok{)}
\NormalTok{oldpar }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{()}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{0}\NormalTok{), }\AttributeTok{mfrow=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(SB}\SpecialCharTok{$}\NormalTok{spatial, }\AttributeTok{col=}\FunctionTok{palBW}\NormalTok{(SB}\SpecialCharTok{$}\NormalTok{spatial}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\NormalTok{nObs),}
     \AttributeTok{border =} \StringTok{"grey"}\NormalTok{, }\AttributeTok{main=}\StringTok{"All years"}\NormalTok{) }\DocumentationTok{\#\# with palette}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.05}\NormalTok{),}
       \AttributeTok{legend =} \FunctionTok{round}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC, }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{col =} \FunctionTok{palBW}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC, }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{title =} \StringTok{"Number of }\SpecialCharTok{\textbackslash{}n}\StringTok{observations"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{bty=}\StringTok{"n"}\NormalTok{)}

\DocumentationTok{\#\# or export other combinations, e.g. one map per observed year}
\NormalTok{yearlySp }\OtherTok{\textless{}{-}} \FunctionTok{exportBirds}\NormalTok{(SB, }
                        \AttributeTok{dimension =} \StringTok{"spatial"}\NormalTok{, }
                        \AttributeTok{timeRes =} \StringTok{"yearly"}\NormalTok{, }
                        \AttributeTok{variable =} \StringTok{"nObs"}\NormalTok{, }
                        \AttributeTok{method =} \StringTok{"sum"}\NormalTok{)}

\NormalTok{maxC }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(yearlySp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\StringTok{\textquotesingle{}2005\textquotesingle{}}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{palBW }\OtherTok{\textless{}{-}}\NormalTok{ leaflet}\SpecialCharTok{::}\FunctionTok{colorNumeric}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"navyblue"}\NormalTok{), }
                               \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC), }
                               \AttributeTok{na.color =} \StringTok{"transparent"}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(yearlySp[}\StringTok{"2005"}\NormalTok{], }\AttributeTok{col=}\FunctionTok{palBW}\NormalTok{(yearlySp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\StringTok{\textquotesingle{}2005\textquotesingle{}}\NormalTok{), }
     \AttributeTok{border =} \StringTok{"grey"}\NormalTok{,}\AttributeTok{main=}\StringTok{"2005"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.05}\NormalTok{),}
       \AttributeTok{legend =} \FunctionTok{round}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC, }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{col =} \FunctionTok{palBW}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC, }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{border =} \StringTok{"grey"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Number of }\SpecialCharTok{\textbackslash{}n}\StringTok{observations"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{bty=}\StringTok{"n"}\NormalTok{)}

\NormalTok{maxC }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(yearlySp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\StringTok{\textquotesingle{}2010\textquotesingle{}}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{palBW }\OtherTok{\textless{}{-}}\NormalTok{ leaflet}\SpecialCharTok{::}\FunctionTok{colorNumeric}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{, }\StringTok{"navyblue"}\NormalTok{), }
                               \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC), }
                               \AttributeTok{na.color =} \StringTok{"transparent"}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(yearlySp[}\StringTok{"2010"}\NormalTok{], }\AttributeTok{col=}\FunctionTok{palBW}\NormalTok{(yearlySp}\SpecialCharTok{@}\NormalTok{data}\SpecialCharTok{$}\StringTok{\textquotesingle{}2010\textquotesingle{}}\NormalTok{), }
     \AttributeTok{border =} \StringTok{"grey"}\NormalTok{,}\AttributeTok{main=}\StringTok{"2010"}\NormalTok{)}
\FunctionTok{legend}\NormalTok{(}\StringTok{"bottomleft"}\NormalTok{, }\AttributeTok{inset =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.05}\NormalTok{),}
       \AttributeTok{legend =} \FunctionTok{round}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC, }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{col =} \FunctionTok{palBW}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, maxC, }\AttributeTok{length.out =} \DecValTok{5}\NormalTok{)),}
       \AttributeTok{border =} \StringTok{"grey"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Number of }\SpecialCharTok{\textbackslash{}n}\StringTok{observations"}\NormalTok{, }\AttributeTok{pch =} \DecValTok{15}\NormalTok{, }\AttributeTok{bty=}\StringTok{"n"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(oldpar)}
\end{Highlighting}
\end{Shaded}

\includegraphics{r-tools-tutorial_files/figure-latex/plotBIRDSspatial-1.pdf}

There are other ways to plot spatial data, here there is another example this time
using the package \texttt{sf} instead of \texttt{sp} and using number of visits as the measure
for sampling effort.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(sf)}
\FunctionTok{library}\NormalTok{(cowplot)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(colorRamps)}
\FunctionTok{library}\NormalTok{(gridExtra)}

\NormalTok{spatial\_sf }\OtherTok{\textless{}{-}} \FunctionTok{st\_as\_sf}\NormalTok{(SB}\SpecialCharTok{$}\NormalTok{spatial)}

\NormalTok{vis }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ spatial\_sf, }\FunctionTok{aes}\NormalTok{( }\AttributeTok{fill =}\NormalTok{ nVis)) }\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Visits"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#56B1F7"}\NormalTok{,}
                      \AttributeTok{high =} \StringTok{"\#132B43"}\NormalTok{,}
                      \AttributeTok{na.value =} \ConstantTok{NA}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\StringTok{"pt"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_cowplot}\NormalTok{()}

\NormalTok{spp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ spatial\_sf ,}\FunctionTok{aes}\NormalTok{( }\AttributeTok{fill =}\NormalTok{ nSpp))}\SpecialCharTok{+}
  \FunctionTok{geom\_sf}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Number of species"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#56B1F7"}\NormalTok{,}
                      \AttributeTok{high =} \StringTok{"\#132B43"}\NormalTok{,}
                      \AttributeTok{na.value =} \ConstantTok{NA}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\StringTok{"pt"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_cowplot}\NormalTok{()}

\FunctionTok{grid.arrange}\NormalTok{(vis, spp, }\AttributeTok{ncol=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{r-tools-tutorial_files/figure-latex/ggplot1-1.pdf}

We see that \texttt{SB} contains an element called \texttt{SB\$temporal} that contains a daily
time series with time specific rows when there is information. \texttt{xts} also supports
time, but dating below day resolution is not yet implemented in the \texttt{BIRDS} package.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sb.xts }\OtherTok{\textless{}{-}}\NormalTok{ SB}\SpecialCharTok{$}\NormalTok{temporal}
\FunctionTok{dim}\NormalTok{(sb.xts)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1118    3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(sb.xts, }\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            nObs nVis nSpp
## 2000-03-24    1    1    1
## 2000-04-05    4    3    3
## 2000-04-06   11    6    3
## 2000-04-10    1    1    1
## 2000-04-12    3    3    1
## 2000-04-13    8    5    2
## 2000-04-20    1    1    1
## 2000-04-21    5    4    2
## 2000-04-23    5    2    3
## 2000-04-24    7    5    2
## 2000-04-26    1    1    1
## 2000-04-27    7    6    3
## 2000-04-28    9    7    3
## 2000-04-29    6    3    3
## 2000-05-27    1    1    1
## 2000-06-03    1    1    1
## 2000-07-30    1    1    1
## 2000-08-03    1    1    1
## 2000-08-05    5    2    5
## 2000-08-06    3    1    3
\end{verbatim}

Sub-setting is convenient in \texttt{xts} as you can do it with its dates and with a \texttt{/}
for a range of dates.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sb.xts[}\StringTok{"2010{-}09{-}07"}\NormalTok{] }\CommentTok{\#a specific day}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            nObs nVis nSpp
## 2010-09-07    9    7    5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sb.xts[}\StringTok{"2010{-}09{-}01/2010{-}09{-}15"}\NormalTok{] }\CommentTok{\#for a period}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            nObs nVis nSpp
## 2010-09-01   38   15   14
## 2010-09-02   26   12   12
## 2010-09-03   20    9   10
## 2010-09-04   63   19   18
## 2010-09-05   71   25   12
## 2010-09-06   16    4    9
## 2010-09-07    9    7    5
## 2010-09-08   13    6    8
## 2010-09-09   32   12   14
## 2010-09-10    1    1    1
## 2010-09-11   15    8    8
## 2010-09-12   15    7    8
## 2010-09-13   14    5    9
## 2010-09-14    1    1    1
## 2010-09-15    3    3    2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sb.xts[}\StringTok{"2010{-}09"}\NormalTok{] }\CommentTok{\#a specific month}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            nObs nVis nSpp
## 2010-09-01   38   15   14
## 2010-09-02   26   12   12
## 2010-09-03   20    9   10
## 2010-09-04   63   19   18
## 2010-09-05   71   25   12
## 2010-09-06   16    4    9
## 2010-09-07    9    7    5
## 2010-09-08   13    6    8
## 2010-09-09   32   12   14
## 2010-09-10    1    1    1
## 2010-09-11   15    8    8
## 2010-09-12   15    7    8
## 2010-09-13   14    5    9
## 2010-09-14    1    1    1
## 2010-09-15    3    3    2
## 2010-09-17    3    2    3
## 2010-09-18    9    5    5
## 2010-09-19   12    7    5
## 2010-09-21    3    2    3
## 2010-09-22    4    4    2
## 2010-09-23    3    3    2
## 2010-09-24   10    5    5
## 2010-09-25    6    3    6
## 2010-09-26    7    6    2
## 2010-09-28    2    2    2
## 2010-09-29    5    3    4
## 2010-09-30    2    2    2
\end{verbatim}

The package \texttt{xts} has several tools for converting to different periods. Here we
will use \texttt{to.monthly}. This provides, the first, min, max, and last of the data.
We can plot the daily maximum number of observations. The plot command with an
\texttt{xts} object provides a TON of features. This makes it fairly easy to customize
your plots. Read more in \texttt{?plot.xts}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(xts)}
\NormalTok{obs.m }\OtherTok{\textless{}{-}} \FunctionTok{to.monthly}\NormalTok{(sb.xts}\SpecialCharTok{$}\NormalTok{nObs) }
\FunctionTok{plot}\NormalTok{(obs.m[}\StringTok{"2000/2010"}\NormalTok{,}\DecValTok{2}\NormalTok{], }
     \AttributeTok{col =} \StringTok{"darkblue"}\NormalTok{, }
     \AttributeTok{grid.ticks.on =} \StringTok{"month"}\NormalTok{, }
     \AttributeTok{major.ticks =} \StringTok{"month"}\NormalTok{, }
     \AttributeTok{grid.col =} \StringTok{"lightgrey"}\NormalTok{,  }
     \AttributeTok{main =} \StringTok{"Maximum number of daily observations/visits per month"}\NormalTok{)}

\NormalTok{vis.m }\OtherTok{\textless{}{-}} \FunctionTok{to.monthly}\NormalTok{(sb.xts}\SpecialCharTok{$}\NormalTok{nVis) }
\FunctionTok{lines}\NormalTok{(vis.m[}\StringTok{"2000/2010"}\NormalTok{,}\DecValTok{2}\NormalTok{], }\AttributeTok{col =} \StringTok{"orange"}\NormalTok{, }\AttributeTok{lwd=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'xts' was built under R version 4.0.4
\end{verbatim}

\begin{verbatim}
## Loading required package: zoo
\end{verbatim}

\begin{verbatim}
## Warning: package 'zoo' was built under R version 4.0.4
\end{verbatim}

\begin{verbatim}
## 
## Attaching package: 'zoo'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:base':
## 
##     as.Date, as.Date.numeric
\end{verbatim}

\begin{verbatim}
## 
## Attaching package: 'xts'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:dplyr':
## 
##     first, last
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:leaflet':
## 
##     addLegend
\end{verbatim}

\includegraphics{r-tools-tutorial_files/figure-latex/monthlyPlot-1.pdf} \includegraphics{r-tools-tutorial_files/figure-latex/monthlyPlot-2.pdf}

We can now look at some particular species and ask whether this has changed in occurrence over time:
Plot no. records of species x and no. visits all species over years (we simply explore by comparing records for a species with no visits, can assume that species has increased of stronger positive trend than for no. visits)

Plot no. gridcells with visits for species x and no. gridcells with visits for all species over years (we simply explore by comparing records for a species with no visits, can assume that species has increased of stronger positive trend than for no. visits)
(species x: TvÃ¥flÃ¤ckad trollslÃ¤nda Epitheca bimaculata)

  \bibliography{references.bib}

\end{document}
