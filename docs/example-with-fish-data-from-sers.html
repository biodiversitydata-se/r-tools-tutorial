<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1 Example with fish data from SERS | Using R tools for analysis  of primary biodiversity data provided by SBDI</title>
  <meta name="description" content="R tools for biodiversity data" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="1 Example with fish data from SERS | Using R tools for analysis  of primary biodiversity data provided by SBDI" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="R tools for biodiversity data" />
  <meta name="github-repo" content="biodiversitydata-se/r-tools-tutorial" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1 Example with fish data from SERS | Using R tools for analysis  of primary biodiversity data provided by SBDI" />
  
  <meta name="twitter:description" content="R tools for biodiversity data" />
  

<meta name="author" content="Debora Arlt and Alejandro Ruete  for the Swedish Biodiversity Data Infrastructure" />


<meta name="date" content="2024-05-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon_io/favicon.ico" type="image/x-icon" />
<link rel="prev" href="index.html"/>
<link rel="next" href="example-with-opportunistic-data-on-dragonflies.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
<link rel="stylesheet" href="toc.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><strong>R tools for biodiversity data</strong></a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#r-and-mirroreum"><i class="fa fa-check"></i>R and Mirroreum</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#sbdi4r2---a-new-r-to-search-an-access-data"><i class="fa fa-check"></i>sbdi4r2 - a new R 📦 to search an access data</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#other-packages-needed"><i class="fa fa-check"></i>Other packages needed</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#your-collaboration-is-appreciated"><i class="fa fa-check"></i>Your collaboration is appreciated</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="example-with-fish-data-from-sers.html"><a href="example-with-fish-data-from-sers.html"><i class="fa fa-check"></i><b>1</b> Example with fish data from SERS</a>
<ul>
<li class="chapter" data-level="1.1" data-path="example-with-fish-data-from-sers.html"><a href="example-with-fish-data-from-sers.html#plotting-data-on-a-map"><i class="fa fa-check"></i><b>1.1</b> Plotting data on a map</a></li>
<li class="chapter" data-level="1.2" data-path="example-with-fish-data-from-sers.html"><a href="example-with-fish-data-from-sers.html#temporal-summary"><i class="fa fa-check"></i><b>1.2</b> Temporal summary</a></li>
<li class="chapter" data-level="1.3" data-path="example-with-fish-data-from-sers.html"><a href="example-with-fish-data-from-sers.html#species-summary"><i class="fa fa-check"></i><b>1.3</b> Species summary</a></li>
<li class="chapter" data-level="1.4" data-path="example-with-fish-data-from-sers.html"><a href="example-with-fish-data-from-sers.html#spatial-biodiversity-analysis"><i class="fa fa-check"></i><b>1.4</b> Spatial biodiversity analysis</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="example-with-opportunistic-data-on-dragonflies.html"><a href="example-with-opportunistic-data-on-dragonflies.html"><i class="fa fa-check"></i><b>2</b> Example with opportunistic data on Dragonflies</a>
<ul>
<li class="chapter" data-level="2.1" data-path="example-with-opportunistic-data-on-dragonflies.html"><a href="example-with-opportunistic-data-on-dragonflies.html#name-searching"><i class="fa fa-check"></i><b>2.1</b> Name searching</a></li>
<li class="chapter" data-level="2.2" data-path="example-with-opportunistic-data-on-dragonflies.html"><a href="example-with-opportunistic-data-on-dragonflies.html#filter-the-search-to-get-the-observations"><i class="fa fa-check"></i><b>2.2</b> Filter the search to get the observations</a></li>
<li class="chapter" data-level="2.3" data-path="example-with-opportunistic-data-on-dragonflies.html"><a href="example-with-opportunistic-data-on-dragonflies.html#quality-and-fit-for-use-check"><i class="fa fa-check"></i><b>2.3</b> Quality and fit-for-use check</a></li>
<li class="chapter" data-level="2.4" data-path="example-with-opportunistic-data-on-dragonflies.html"><a href="example-with-opportunistic-data-on-dragonflies.html#species-trends"><i class="fa fa-check"></i><b>2.4</b> Species trends</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Using R tools for analysis <br>of primary biodiversity data provided by SBDI</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="example-with-fish-data-from-sers" class="section level1 hasAnchor" number="1">
<h1><span class="header-section-number">1</span> Example with fish data from SERS<a href="example-with-fish-data-from-sers.html#example-with-fish-data-from-sers" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this example we are interested in exploring data from a specific data resource – the Swedish Electrofishing Registry - SERS (Department of Aquatic Resources, SLU Aqua). This database has 2.8 M observations starting in the 1950’s.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="example-with-fish-data-from-sers.html#cb6-1" tabindex="-1"></a><span class="fu">library</span>(sbdi4r2)</span>
<span id="cb6-2"><a href="example-with-fish-data-from-sers.html#cb6-2" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb6-3"><a href="example-with-fish-data-from-sers.html#cb6-3" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-4"><a href="example-with-fish-data-from-sers.html#cb6-4" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code></pre></div>
<p>SBDI is a collection of many biodiversity databases. We start by searching for the data resource we are interested in by using the function <code>pick_filter()</code>. This is an interactive query guiding you through the many resources available to filtering your query (data resources, spatial layers, and curated species lists).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="example-with-fish-data-from-sers.html#cb7-1" tabindex="-1"></a>fq_str <span class="ot">&lt;-</span> <span class="fu">pick_filter</span>(<span class="st">&quot;resource&quot;</span>) </span>
<span id="cb7-2"><a href="example-with-fish-data-from-sers.html#cb7-2" tabindex="-1"></a><span class="co"># follow the instructions </span></span></code></pre></div>
<p>Follow the instructions. Your choices here would have been “in3” :arrow_right: “dr10” (data resource 10 = SERS). Your variable <code>fq_str</code> will now contain a string “data_resource_uid:dr10”.</p>
<p><strong>Note: the function pick_filter() is temporarily disabled until it could be adapted to the new galah framework.</strong></p>
<p>But we are not interested in the complete database, we only want to look at the data from the last 10 years. For this we add another filter string. Both filter strings (for data resource and for time period) will be treated as AND factors.</p>
<p>Using the function <code>sbdi_call()</code> we can now query for the observations fulfilling our filter.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="example-with-fish-data-from-sers.html#cb8-1" tabindex="-1"></a>xf <span class="ot">&lt;-</span> <span class="fu">sbdi_call</span>() <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="example-with-fish-data-from-sers.html#cb8-2" tabindex="-1"></a>  <span class="fu">filter</span>(dataResourceUid <span class="sc">==</span> <span class="st">&quot;dr10&quot;</span>,</span>
<span id="cb8-3"><a href="example-with-fish-data-from-sers.html#cb8-3" tabindex="-1"></a>         year <span class="sc">&gt;=</span> <span class="dv">2014</span>, year <span class="sc">&lt;=</span> <span class="dv">2024</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="example-with-fish-data-from-sers.html#cb8-4" tabindex="-1"></a>  <span class="fu">atlas_occurrences</span>()</span></code></pre></div>
<pre><code>## ---</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="example-with-fish-data-from-sers.html#cb10-1" tabindex="-1"></a>xf <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="example-with-fish-data-from-sers.html#cb10-2" tabindex="-1"></a>  <span class="fu">pull</span>(dataResourceName) <span class="sc">|&gt;</span> </span>
<span id="cb10-3"><a href="example-with-fish-data-from-sers.html#cb10-3" tabindex="-1"></a>  <span class="fu">table</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-4"><a href="example-with-fish-data-from-sers.html#cb10-4" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-5"><a href="example-with-fish-data-from-sers.html#cb10-5" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&quot;Source&quot;</span> <span class="ot">=</span> Var1)</span></code></pre></div>
<pre><code>##                                                                              Source
## 1 SLU Aqua  Institute of Freshwater Research Swedish Electrofishing Registry - SERS
##    Freq
## 1 26907</code></pre>
<div id="plotting-data-on-a-map" class="section level2 hasAnchor" number="1.1">
<h2><span class="header-section-number">1.1</span> Plotting data on a map<a href="example-with-fish-data-from-sers.html#plotting-data-on-a-map" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are many other ways of producing spatial plots in R, for example you can quickly plot all the observations with <code>plot()</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="example-with-fish-data-from-sers.html#cb12-1" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;swe_wgs84&quot;</span>, <span class="at">package =</span> <span class="st">&quot;sbdi4r2&quot;</span>, <span class="at">envir =</span> <span class="fu">environment</span>())</span>
<span id="cb12-2"><a href="example-with-fish-data-from-sers.html#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="example-with-fish-data-from-sers.html#cb12-3" tabindex="-1"></a><span class="fu">plot</span>(swe_wgs84[[<span class="st">&quot;Border&quot;</span>]]<span class="sc">$</span>geometry, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">border =</span> <span class="cn">NA</span>) </span>
<span id="cb12-4"><a href="example-with-fish-data-from-sers.html#cb12-4" tabindex="-1"></a>  <span class="fu">points</span>(xf<span class="sc">$</span>decimalLongitude, xf<span class="sc">$</span>decimalLatitude, <span class="at">pch =</span> <span class="st">&quot;.&quot;</span>, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<p><img src="r-tools-tutorial_files/figure-html/pdf_plot-1.png" width="672" /></p>
</div>
<div id="temporal-summary" class="section level2 hasAnchor" number="1.2">
<h2><span class="header-section-number">1.2</span> Temporal summary<a href="example-with-fish-data-from-sers.html#temporal-summary" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A quick summary over the years reveals a drop in number of records over time.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="example-with-fish-data-from-sers.html#cb13-1" tabindex="-1"></a>xf<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">year</span>(xf<span class="sc">$</span>eventDate)</span>
<span id="cb13-2"><a href="example-with-fish-data-from-sers.html#cb13-2" tabindex="-1"></a><span class="fu">table</span>(xf<span class="sc">$</span>year)</span></code></pre></div>
<pre><code>## 
##  2014  2015  2016  2017  2018  2019  2020  2021 
## 10299  3613  2773  2781  3424  2903  1042    72</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="example-with-fish-data-from-sers.html#cb15-1" tabindex="-1"></a><span class="fu">hist</span>(xf<span class="sc">$</span>year, </span>
<span id="cb15-2"><a href="example-with-fish-data-from-sers.html#cb15-2" tabindex="-1"></a>     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2014</span>, <span class="dv">2024</span>), </span>
<span id="cb15-3"><a href="example-with-fish-data-from-sers.html#cb15-3" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Year&quot;</span>, </span>
<span id="cb15-4"><a href="example-with-fish-data-from-sers.html#cb15-4" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<p><img src="r-tools-tutorial_files/figure-html/timeHist-1.png" width="672" /></p>
</div>
<div id="species-summary" class="section level2 hasAnchor" number="1.3">
<h2><span class="header-section-number">1.3</span> Species summary<a href="example-with-fish-data-from-sers.html#species-summary" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the same way we can summarise the number of observations for each species.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="example-with-fish-data-from-sers.html#cb16-1" tabindex="-1"></a>sppTab <span class="ot">&lt;-</span> <span class="fu">table</span>(xf<span class="sc">$</span>scientificName)</span>
<span id="cb16-2"><a href="example-with-fish-data-from-sers.html#cb16-2" tabindex="-1"></a>sppDF <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sppTab)</span>
<span id="cb16-3"><a href="example-with-fish-data-from-sers.html#cb16-3" tabindex="-1"></a><span class="fu">colnames</span>(sppDF)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;species&quot;</span></span>
<span id="cb16-4"><a href="example-with-fish-data-from-sers.html#cb16-4" tabindex="-1"></a><span class="fu">head</span>(sppDF)</span></code></pre></div>
<pre><code>##               species Freq
## 1       Abramis brama    3
## 2   Alburnus alburnus  103
## 3   Anguilla anguilla  285
## 4           Astacidae   23
## 5     Astacus astacus   73
## 6 Barbatula barbatula   45</code></pre>
<p>Perhaps, you want to send this table as a .CSV file to a colleague. Save the table:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="example-with-fish-data-from-sers.html#cb18-1" tabindex="-1"></a><span class="fu">write.csv</span>(sppDF, <span class="st">&quot;data/SERS_species_summary.csv&quot;</span>)</span>
<span id="cb18-2"><a href="example-with-fish-data-from-sers.html#cb18-2" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: again this will be saved on your working directory</span></span></code></pre></div>
</div>
<div id="spatial-biodiversity-analysis" class="section level2 hasAnchor" number="1.4">
<h2><span class="header-section-number">1.4</span> Spatial biodiversity analysis<a href="example-with-fish-data-from-sers.html#spatial-biodiversity-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s now ask: How does the species richness vary across Sweden?</p>
<p>For this we want to summarise occurrences species-wise over a defined grid instead of plotting every observation point. First we need to overlay the observations with a grid. Here we are using the standard Swedish grids with grid square size of 50, 25, 10 or 5 km provided as data in the sbdi4r2 package (with Coordinate Reference System = WGS84, EPSG:4326).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="example-with-fish-data-from-sers.html#cb19-1" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># the function coordinates() and proj4string() are in sp</span></span>
<span id="cb19-2"><a href="example-with-fish-data-from-sers.html#cb19-2" tabindex="-1"></a><span class="co"># load some shapes over Sweden&#39;s political borders</span></span>
<span id="cb19-3"><a href="example-with-fish-data-from-sers.html#cb19-3" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;swe_wgs84&quot;</span>, <span class="at">package =</span> <span class="st">&quot;sbdi4r2&quot;</span>, <span class="at">envir =</span> <span class="fu">environment</span>())</span>
<span id="cb19-4"><a href="example-with-fish-data-from-sers.html#cb19-4" tabindex="-1"></a><span class="co"># a standard 50 km grid</span></span>
<span id="cb19-5"><a href="example-with-fish-data-from-sers.html#cb19-5" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;Sweden_Grid_50km_Wgs84&quot;</span>, <span class="at">package =</span> <span class="st">&quot;sbdi4r2&quot;</span>, <span class="at">envir =</span> <span class="fu">environment</span>())</span>
<span id="cb19-6"><a href="example-with-fish-data-from-sers.html#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="example-with-fish-data-from-sers.html#cb19-7" tabindex="-1"></a>grid <span class="ot">&lt;-</span> Sweden_Grid_50km_Wgs84</span>
<span id="cb19-8"><a href="example-with-fish-data-from-sers.html#cb19-8" tabindex="-1"></a></span>
<span id="cb19-9"><a href="example-with-fish-data-from-sers.html#cb19-9" tabindex="-1"></a><span class="co"># make the observations spatial</span></span>
<span id="cb19-10"><a href="example-with-fish-data-from-sers.html#cb19-10" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: make sure there are no NAs in the columns defining the coordinates</span></span>
<span id="cb19-11"><a href="example-with-fish-data-from-sers.html#cb19-11" tabindex="-1"></a><span class="co"># xf$data[!is.na(xf$data$longitude) | !is.na(xf$data$latitude),]</span></span>
<span id="cb19-12"><a href="example-with-fish-data-from-sers.html#cb19-12" tabindex="-1"></a></span>
<span id="cb19-13"><a href="example-with-fish-data-from-sers.html#cb19-13" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(<span class="fu">as.data.frame</span>(xf),</span>
<span id="cb19-14"><a href="example-with-fish-data-from-sers.html#cb19-14" tabindex="-1"></a>                <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;decimalLongitude&quot;</span>,<span class="st">&quot;decimalLatitude&quot;</span>),</span>
<span id="cb19-15"><a href="example-with-fish-data-from-sers.html#cb19-15" tabindex="-1"></a>                <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>))</span>
<span id="cb19-16"><a href="example-with-fish-data-from-sers.html#cb19-16" tabindex="-1"></a></span>
<span id="cb19-17"><a href="example-with-fish-data-from-sers.html#cb19-17" tabindex="-1"></a><span class="co"># overlay the occurrence data with the grid</span></span>
<span id="cb19-18"><a href="example-with-fish-data-from-sers.html#cb19-18" tabindex="-1"></a>ObsInGridListID <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(grid, obs)</span>
<span id="cb19-19"><a href="example-with-fish-data-from-sers.html#cb19-19" tabindex="-1"></a>ObsInGridList <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ObsInGridListID, <span class="cf">function</span>(x) <span class="fu">st_drop_geometry</span>(obs[x,]))</span>
<span id="cb19-20"><a href="example-with-fish-data-from-sers.html#cb19-20" tabindex="-1"></a>wNonEmpty <span class="ot">&lt;-</span> <span class="fu">unname</span>( <span class="fu">which</span>( <span class="fu">unlist</span>(<span class="fu">lapply</span>(ObsInGridList, nrow)) <span class="sc">!=</span> <span class="dv">0</span>) )</span></code></pre></div>
<p>The result <code>ObsInGridList</code> is a <code>list</code> object with a subset of the data for each grid cell. Now summarise occurrences within grid cells:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="example-with-fish-data-from-sers.html#cb20-1" tabindex="-1"></a><span class="co"># check n the total number of observations</span></span>
<span id="cb20-2"><a href="example-with-fish-data-from-sers.html#cb20-2" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(ObsInGridList, nrow)))</span></code></pre></div>
<pre><code>## [1] 26907</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="example-with-fish-data-from-sers.html#cb22-1" tabindex="-1"></a><span class="co"># apply a summary over the grid cells </span></span>
<span id="cb22-2"><a href="example-with-fish-data-from-sers.html#cb22-2" tabindex="-1"></a>nCells <span class="ot">&lt;-</span> <span class="fu">length</span>(ObsInGridList)</span>
<span id="cb22-3"><a href="example-with-fish-data-from-sers.html#cb22-3" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;nObs&quot;</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">rep</span>(<span class="cn">NA</span>,nCells)),</span>
<span id="cb22-4"><a href="example-with-fish-data-from-sers.html#cb22-4" tabindex="-1"></a>                  <span class="st">&quot;nYears&quot;</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">rep</span>(<span class="cn">NA</span>,nCells)),</span>
<span id="cb22-5"><a href="example-with-fish-data-from-sers.html#cb22-5" tabindex="-1"></a>                  <span class="st">&quot;nSpp&quot;</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">rep</span>(<span class="cn">NA</span>,nCells)),</span>
<span id="cb22-6"><a href="example-with-fish-data-from-sers.html#cb22-6" tabindex="-1"></a>                  <span class="at">row.names =</span> <span class="fu">row.names</span>(grid),</span>
<span id="cb22-7"><a href="example-with-fish-data-from-sers.html#cb22-7" tabindex="-1"></a>                  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-8"><a href="example-with-fish-data-from-sers.html#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="example-with-fish-data-from-sers.html#cb22-9" tabindex="-1"></a>cols2use <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;scientificName&quot;</span>, <span class="st">&quot;year&quot;</span>)</span>
<span id="cb22-10"><a href="example-with-fish-data-from-sers.html#cb22-10" tabindex="-1"></a>dataRes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ObsInGridList[wNonEmpty], </span>
<span id="cb22-11"><a href="example-with-fish-data-from-sers.html#cb22-11" tabindex="-1"></a>                  <span class="cf">function</span>(x){</span>
<span id="cb22-12"><a href="example-with-fish-data-from-sers.html#cb22-12" tabindex="-1"></a>                    x <span class="ot">&lt;-</span> x[,cols2use]</span>
<span id="cb22-13"><a href="example-with-fish-data-from-sers.html#cb22-13" tabindex="-1"></a>                    <span class="fu">colnames</span>(x) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;scientificName&quot;</span>, <span class="st">&quot;year&quot;</span>)</span>
<span id="cb22-14"><a href="example-with-fish-data-from-sers.html#cb22-14" tabindex="-1"></a>                    <span class="fu">return</span>(<span class="fu">c</span>(<span class="st">&quot;nObs&quot;</span> <span class="ot">=</span> <span class="fu">length</span>(x[,<span class="st">&quot;scientificName&quot;</span>]),</span>
<span id="cb22-15"><a href="example-with-fish-data-from-sers.html#cb22-15" tabindex="-1"></a>                             <span class="st">&quot;nYears&quot;</span> <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(x[,<span class="st">&quot;year&quot;</span>])),</span>
<span id="cb22-16"><a href="example-with-fish-data-from-sers.html#cb22-16" tabindex="-1"></a>                             <span class="st">&quot;nSpp&quot;</span> <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(x[,<span class="st">&quot;scientificName&quot;</span>]))</span>
<span id="cb22-17"><a href="example-with-fish-data-from-sers.html#cb22-17" tabindex="-1"></a>                             )</span>
<span id="cb22-18"><a href="example-with-fish-data-from-sers.html#cb22-18" tabindex="-1"></a>                           )</span>
<span id="cb22-19"><a href="example-with-fish-data-from-sers.html#cb22-19" tabindex="-1"></a>                    }</span>
<span id="cb22-20"><a href="example-with-fish-data-from-sers.html#cb22-20" tabindex="-1"></a>                  )</span>
<span id="cb22-21"><a href="example-with-fish-data-from-sers.html#cb22-21" tabindex="-1"></a>dataRes <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(dataRes, <span class="at">.id =</span> <span class="st">&quot;gridID&quot;</span>))</span>
<span id="cb22-22"><a href="example-with-fish-data-from-sers.html#cb22-22" tabindex="-1"></a>res[wNonEmpty,] <span class="ot">&lt;-</span> dataRes[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb22-23"><a href="example-with-fish-data-from-sers.html#cb22-23" tabindex="-1"></a>resSf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(<span class="fu">data.frame</span>(res, <span class="fu">st_geometry</span>(grid)))</span></code></pre></div>
<p>And finally plot the grid summary as a map:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="example-with-fish-data-from-sers.html#cb23-1" tabindex="-1"></a>palBW <span class="ot">&lt;-</span> leaflet<span class="sc">::</span><span class="fu">colorNumeric</span>(<span class="fu">c</span>(<span class="st">&quot;white&quot;</span>, <span class="st">&quot;navyblue&quot;</span>),</span>
<span id="cb23-2"><a href="example-with-fish-data-from-sers.html#cb23-2" tabindex="-1"></a>                               <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(resSf<span class="sc">$</span>nSpp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb23-3"><a href="example-with-fish-data-from-sers.html#cb23-3" tabindex="-1"></a>                               <span class="at">na.color =</span> <span class="st">&quot;transparent&quot;</span>)</span>
<span id="cb23-4"><a href="example-with-fish-data-from-sers.html#cb23-4" tabindex="-1"></a>oldpar <span class="ot">&lt;-</span> <span class="fu">par</span>()</span>
<span id="cb23-5"><a href="example-with-fish-data-from-sers.html#cb23-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb23-6"><a href="example-with-fish-data-from-sers.html#cb23-6" tabindex="-1"></a><span class="fu">plot</span>(resSf<span class="sc">$</span>geometry, <span class="at">col =</span> <span class="fu">palBW</span>(resSf<span class="sc">$</span>nSpp), <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb23-7"><a href="example-with-fish-data-from-sers.html#cb23-7" tabindex="-1"></a><span class="fu">plot</span>(swe_wgs84<span class="sc">$</span>Border<span class="sc">$</span>geometry, <span class="at">border =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">add =</span> T)</span>
<span id="cb23-8"><a href="example-with-fish-data-from-sers.html#cb23-8" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, </span>
<span id="cb23-9"><a href="example-with-fish-data-from-sers.html#cb23-9" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">round</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(resSf<span class="sc">$</span>nSpp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">length.out =</span> <span class="dv">5</span>)),</span>
<span id="cb23-10"><a href="example-with-fish-data-from-sers.html#cb23-10" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">palBW</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(resSf<span class="sc">$</span>nSpp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">length.out =</span> <span class="dv">5</span>)),</span>
<span id="cb23-11"><a href="example-with-fish-data-from-sers.html#cb23-11" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Number of </span><span class="sc">\n</span><span class="st">species&quot;</span>, <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">bty=</span><span class="st">&quot;n&quot;</span>)</span>
<span id="cb23-12"><a href="example-with-fish-data-from-sers.html#cb23-12" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code></pre></div>
<p><img src="r-tools-tutorial_files/figure-html/gridPlot-1.png" width="576" /></p>
<p>We may now ask whether species richness varies across latitude. So we go further by arranging the observations by latitude:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="example-with-fish-data-from-sers.html#cb24-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-2"><a href="example-with-fish-data-from-sers.html#cb24-2" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb24-3"><a href="example-with-fish-data-from-sers.html#cb24-3" tabindex="-1"></a>xgridded <span class="ot">&lt;-</span> xf <span class="sc">|&gt;</span></span>
<span id="cb24-4"><a href="example-with-fish-data-from-sers.html#cb24-4" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">longitude =</span> <span class="fu">round</span>(decimalLongitude <span class="sc">*</span> <span class="dv">4</span>)<span class="sc">/</span><span class="dv">4</span>, </span>
<span id="cb24-5"><a href="example-with-fish-data-from-sers.html#cb24-5" tabindex="-1"></a>           <span class="at">latitude =</span> <span class="fu">round</span>(decimalLatitude <span class="sc">*</span> <span class="dv">4</span>)<span class="sc">/</span><span class="dv">4</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-6"><a href="example-with-fish-data-from-sers.html#cb24-6" tabindex="-1"></a>    <span class="fu">group_by</span>(longitude,latitude) <span class="sc">|&gt;</span></span>
<span id="cb24-7"><a href="example-with-fish-data-from-sers.html#cb24-7" tabindex="-1"></a>    <span class="do">## subset to vars of interest</span></span>
<span id="cb24-8"><a href="example-with-fish-data-from-sers.html#cb24-8" tabindex="-1"></a>    <span class="fu">select</span>(longitude, latitude, scientificName) <span class="sc">|&gt;</span></span>
<span id="cb24-9"><a href="example-with-fish-data-from-sers.html#cb24-9" tabindex="-1"></a>    <span class="do">## take one row per cell per species (presence)</span></span>
<span id="cb24-10"><a href="example-with-fish-data-from-sers.html#cb24-10" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-11"><a href="example-with-fish-data-from-sers.html#cb24-11" tabindex="-1"></a>    <span class="do">## calculate species richness</span></span>
<span id="cb24-12"><a href="example-with-fish-data-from-sers.html#cb24-12" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">richness =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb24-13"><a href="example-with-fish-data-from-sers.html#cb24-13" tabindex="-1"></a>    <span class="do">## convert to wide format (sites by species)</span></span>
<span id="cb24-14"><a href="example-with-fish-data-from-sers.html#cb24-14" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">present =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-15"><a href="example-with-fish-data-from-sers.html#cb24-15" tabindex="-1"></a>    <span class="fu">do</span>(tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">data =</span> .,  </span>
<span id="cb24-16"><a href="example-with-fish-data-from-sers.html#cb24-16" tabindex="-1"></a>                          <span class="at">names_from =</span> scientificName, </span>
<span id="cb24-17"><a href="example-with-fish-data-from-sers.html#cb24-17" tabindex="-1"></a>                          <span class="at">values_from =</span> present, </span>
<span id="cb24-18"><a href="example-with-fish-data-from-sers.html#cb24-18" tabindex="-1"></a>                          <span class="at">values_fill =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-19"><a href="example-with-fish-data-from-sers.html#cb24-19" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb24-20"><a href="example-with-fish-data-from-sers.html#cb24-20" tabindex="-1"></a><span class="do">## where a species was not present, it will have NA: convert these to 0</span></span>
<span id="cb24-21"><a href="example-with-fish-data-from-sers.html#cb24-21" tabindex="-1"></a>sppcols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(xgridded),</span>
<span id="cb24-22"><a href="example-with-fish-data-from-sers.html#cb24-22" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;richness&quot;</span>))</span>
<span id="cb24-23"><a href="example-with-fish-data-from-sers.html#cb24-23" tabindex="-1"></a>xgridded <span class="ot">&lt;-</span> xgridded <span class="sc">|&gt;</span> </span>
<span id="cb24-24"><a href="example-with-fish-data-from-sers.html#cb24-24" tabindex="-1"></a>  <span class="fu">mutate_at</span>(sppcols, <span class="cf">function</span>(z) <span class="fu">ifelse</span>(<span class="fu">is.na</span>(z), <span class="dv">0</span>, z))</span></code></pre></div>
<p>And plot it accordingly:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="example-with-fish-data-from-sers.html#cb25-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb25-2"><a href="example-with-fish-data-from-sers.html#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="example-with-fish-data-from-sers.html#cb25-3" tabindex="-1"></a><span class="fu">ggplot</span>(xgridded, <span class="fu">aes</span>(latitude, richness)) <span class="sc">+</span> </span>
<span id="cb25-4"><a href="example-with-fish-data-from-sers.html#cb25-4" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Latitude (º)&quot;</span>, </span>
<span id="cb25-5"><a href="example-with-fish-data-from-sers.html#cb25-5" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Species richness&quot;</span>) <span class="sc">+</span></span>
<span id="cb25-6"><a href="example-with-fish-data-from-sers.html#cb25-6" tabindex="-1"></a>  <span class="fu">lims</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb25-7"><a href="example-with-fish-data-from-sers.html#cb25-7" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb25-8"><a href="example-with-fish-data-from-sers.html#cb25-8" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="r-tools-tutorial_files/figure-html/plot_richLat-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="example-with-opportunistic-data-on-dragonflies.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["r-tools-tutorial.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "chapter"
}
});
});
</script>

</body>

</html>
